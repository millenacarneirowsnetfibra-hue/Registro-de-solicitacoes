<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão de Solicitações Operacional</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.1/dist/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { 
            getFirestore, 
            collection, 
            getDocs, 
            addDoc, 
            doc, 
            setDoc,
            deleteDoc,
            onSnapshot,
            query,
            where,
            updateDoc
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyD3tWszcQHgbvIdy-0vPJngZ5oM-iK7fU8",
            authDomain: "gestao-uniformes-7dda8.firebaseapp.com",
            projectId: "gestao-uniformes-7dda8",
            storageBucket: "gestao-uniformes-7dda8.firebasestorage.app",
            messagingSenderId: "1094790093649",
            appId: "1:1094790093649:web:04dcdc01d2207ed2885f15"
        };

        try {
            // Inicializar Firebase
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);

            // Funções para exportar para uso global
            window.firebaseDB = db;
            window.firebaseFunctions = {
                collection,
                getDocs,
                addDoc,
                doc,
                setDoc,
                deleteDoc,
                onSnapshot,
                query,
                where,
                updateDoc
            };

            console.log("Firebase inicializado com sucesso!");
        } catch (error) {
            console.error("Erro ao inicializar Firebase:", error);
            window.firebaseDB = null;
            window.firebaseFunctions = null;
        }
    </script>
    <style>
        /* A */
        .active {
            display: flex;
        }
        
        .align-center {
            align-items: center;
        }

        /* B */
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .badge-danger {
            background-color: #fee2e2;
            color: var(--danger);
        }

        .badge-info {
            background-color: #dbeafe;
            color: var(--info);
        }

        .badge-secondary {
            background-color: #e5e7eb;
            color: var(--gray-dark);
        }

        .badge-success {
            background-color: #d1fae5;
            color: var(--secondary);
        }

        .badge-warning {
            background-color: #fef3c7;
            color: var(--warning);
        }

        body {
            background-color: #f5f7fa;
            color: var(--dark);
            line-height: 1.5;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-weight: 500;
            font-size: 0.9rem;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }

        .btn-danger {
            background-color: var(--danger);
            color: white;
        }

        .btn-icon {
            width: 36px;
            height: 36px;
            padding: 0;
            justify-content: center;
            border-radius: 6px;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-secondary {
            background-color: white;
            color: var(--dark);
            border: 1px solid var(--border);
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.85rem;
        }

        .btn-success {
            background-color: var(--secondary);
            color: white;
        }

        .btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .btn:active {
            transform: translateY(0);
        }

        /* C */
        .chart-card {
            background: white;
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            height: 350px;
        }

        .chart-card h4 {
            margin-bottom: 16px;
            color: var(--dark);
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chart-wrapper {
            height: 250px;
            position: relative;
        }

        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .container {
            display: flex;
            min-height: 100vh;
            width: 100%;
        }

        .content-section {
            background: white;
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }

        /* D */
        .danger-zone {
            background-color: #fee2e2;
            border: 2px solid var(--danger);
            padding: 20px;
            border-radius: var(--radius);
            margin-top: 30px;
        }

        .danger-zone h4 {
            color: var(--danger);
            margin-bottom: 15px;
        }

        .danger-zone p {
            color: #666;
            margin-bottom: 15px;
        }

        .dashboard-filters {
            background: white;
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }

        .d-flex {
            display: flex;
        }

        /* E */
        .empresa-badge {
            display: inline-block;
            background-color: #f0f9ff;
            color: #0369a1;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            margin-left: 8px;
        }

        /* F */
        .filter-group {
            flex: 1;
            min-width: 200px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .filter-group label {
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--dark);
        }

        .filter-group select, .filter-group input {
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            font-size: 0.9rem;
            background: white;
        }

        .filter-group select:focus, .filter-group input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .filter-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: var(--primary-light);
            color: var(--primary);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            margin-left: 8px;
        }

        .filter-indicator .clear-filter {
            cursor: pointer;
            font-size: 0.9rem;
        }

        .filter-indicator .clear-filter:hover {
            color: var(--danger);
        }

        .filters-row {
            display: flex;
            gap: 16px;
            align-items: flex-end;
            flex-wrap: wrap;
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 24px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }

        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            font-size: 0.9rem;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: var(--dark);
            font-size: 0.9rem;
        }

        /* G */
        .gap-1 { gap: 4px; }
        .gap-2 { gap: 8px; }
        .gap-3 { gap: 12px; }

        /* H */
        .header {
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h2 {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--dark);
        }

        .header-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        /* I */
        .item-name {
            flex: 1;
        }

        .item-with-sizes {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .item-with-quantity {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .item-list {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .item-list-row {
            display: flex;
            flex-direction: column;
            padding: 4px 0;
        }

        /* J */
        .justify-between {
            justify-content: space-between;
        }

        /* L */
        .logo {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
        }

        .logo-text h1 {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--dark);
        }

        .logo-text p {
            font-size: 0.8rem;
            color: var(--gray);
        }

        /* M */
        .mb-1 { margin-bottom: 4px; }
        .mb-2 { margin-bottom: 8px; }
        .mb-3 { margin-bottom: 12px; }
        .mb-4 { margin-bottom: 16px; }

        .main-content {
            flex: 1;
            margin-left: 250px;
            padding: 30px;
            background-color: #f5f7fa;
            width: calc(100% - 250px);
            min-height: 100vh;
        }

        .media-tempo-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .media-tempo-badge.alta {
            background: #fef2f2;
            color: #dc2626;
        }

        .media-tempo-badge.baixa {
            background: #f0fdf4;
            color: #16a34a;
        }

        .media-tempo-badge.media {
            background: #fffbeb;
            color: #d97706;
        }

        .media-tempo-card {
            background: white;
            border-radius: var(--radius-sm);
            padding: 16px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
        }

        .media-tempo-categoria {
            font-size: 0.75rem;
            color: var(--gray);
            background: var(--gray-light);
            padding: 2px 8px;
            border-radius: 10px;
            display: inline-block;
            margin-top: 4px;
        }

        .media-tempo-descricao {
            font-size: 0.8rem;
            color: var(--gray);
        }

        .media-tempo-footer {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: var(--gray);
        }

        .media-tempo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }

        .media-tempo-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .media-tempo-nome {
            font-weight: 600;
            color: var(--dark);
            font-size: 0.95rem;
        }

        .media-tempo-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }

        .media-tempo-valor {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 4px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray);
            width: 32px;
            height: 32px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            background-color: var(--gray-light);
        }

        .modal-content {
            background: white;
            border-radius: var(--radius);
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--dark);
        }

        .mt-1 { margin-top: 4px; }
        .mt-2 { margin-top: 8px; }
        .mt-3 { margin-top: 12px; }
        .mt-4 { margin-top: 16px; }

        /* N */
        .nav-item {
            margin: 4px 16px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            color: var(--gray-dark);
            text-decoration: none;
            border-radius: var(--radius-sm);
            transition: var(--transition);
            font-weight: 500;
            gap: 12px;
            font-size: 0.95rem;
        }

        .nav-link.active {
            background-color: var(--primary-light);
            color: var(--primary);
            font-weight: 600;
        }

        .nav-link:hover {
            background-color: var(--primary-light);
            color: var(--primary);
        }

        .nav-link i {
            width: 20px;
            font-size: 1rem;
            text-align: center;
        }

        .nav-menu {
            flex: 1;
            padding: 20px 0;
        }

        /* Q */
        .quantity-input {
            width: 80px;
        }

        /* R */
        .remover-item {
            cursor: pointer;
        }

        /* S */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border);
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .show {
            display: block !important;
        }

        .sidebar {
            width: 250px;
            background: white;
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            z-index: 10;
            box-shadow: var(--shadow);
        }

        .size-select {
            width: 100px;
        }

        .stat-card {
            background: white;
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            transition: var(--transition);
        }

        .stat-card:hover {
            box-shadow: var(--shadow-md);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .stat-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
        }

        .stat-icon.blue {
            background-color: var(--primary-light);
            color: var(--primary);
        }

        .stat-icon.green {
            background-color: #d1fae5;
            color: var(--secondary);
        }

        .stat-icon.orange {
            background-color: #fef3c7;
            color: var(--warning);
        }

        .stat-icon.purple {
            background-color: #ede9fe;
            color: var(--accent);
        }

        .stat-label {
            font-size: 0.85rem;
            color: var(--gray);
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--dark);
            line-height: 1;
            margin-bottom: 4px;
        }

        .status-actions {
            display: flex;
            gap: 4px;
        }

        .status-btn {
            padding: 4px 8px;
            border: 1px solid var(--border);
            border-radius: 4px;
            background: white;
            cursor: pointer;
            font-size: 0.8rem;
            transition: var(--transition);
        }

        .status-btn:hover {
            background: var(--gray-light);
        }

        .status-btn.nao-precisa {
            color: var(--danger);
            border-color: var(--danger);
        }

        .status-btn.pendente {
            color: var(--warning);
            border-color: var(--warning);
        }

        .status-btn.realizado {
            color: var(--secondary);
            border-color: var(--secondary);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 30px;
        }

        /* T */
        .table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        .table th {
            background-color: var(--gray-light);
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: var(--dark);
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--border);
        }

        .table td {
            padding: 12px;
            border-bottom: 1px solid var(--border);
            color: var(--gray-dark);
            font-size: 0.9rem;
        }

        .table tr:hover {
            background-color: var(--gray-light);
        }

        .table tr:last-child td {
            border-bottom: none;
        }

        .table-container {
            overflow-x: auto;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
        }

        .text-center {
            text-align: center;
        }

        .text-muted {
            color: var(--gray);
        }

        .toast {
            position: fixed;
            top: 24px;
            right: 24px;
            padding: 16px 20px;
            border-radius: var(--radius-sm);
            background: white;
            box-shadow: var(--shadow-md);
            border-left: 4px solid var(--primary);
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 1001;
            transform: translateX(120%);
            transition: transform 0.3s ease;
        }

        .toast-error {
            border-left-color: var(--danger);
        }

        .toast-success {
            border-left-color: var(--secondary);
        }

        .toast.show {
            transform: translateX(0);
        }

        .tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
        }

        .tooltip .tooltip-text {
            visibility: hidden;
            width: 200px;
            background-color: var(--dark);
            color: white;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.8rem;
            font-weight: normal;
        }

        .tooltip .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: var(--dark) transparent transparent transparent;
        }

        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        .top-card {
            background: white;
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }

        .top-card h4 {
            margin-bottom: 16px;
            color: var(--dark);
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .top-count {
            font-weight: 600;
            color: var(--primary);
            font-size: 1.1rem;
        }

        .top-details {
            font-size: 0.8rem;
            color: var(--gray);
        }

        .top-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .top-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }

        .top-item:last-child {
            border-bottom: none;
        }

        .top-list {
            list-style: none;
        }

        .top-name {
            font-weight: 500;
            color: var(--dark);
            font-size: 0.9rem;
        }

        .top-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        /* U */
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .user-info h4 {
            font-size: 0.9rem;
            font-weight: 600;
        }

        .user-info p {
            font-size: 0.8rem;
            color: var(--gray);
        }

        .user-section {
            padding: 20px;
            border-top: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* Responsividade */
        @media (max-width: 1024px) {
            .main-content {
                margin-left: 70px;
                width: calc(100% - 70px);
                padding: 20px;
            }

            .sidebar {
                width: 70px;
            }

            .sidebar .logo {
                justify-content: center;
                padding: 15px 0;
            }

            .sidebar .logo-text,
            .sidebar .nav-link span,
            .sidebar .user-info {
                display: none;
            }

            .sidebar .nav-link {
                justify-content: center;
                padding: 14px;
            }
            
            .sidebar .user-section {
                justify-content: center;
                padding: 15px 0;
            }
            
            .sidebar .user-avatar {
                width: 35px;
                height: 35px;
            }
            
            .charts-container {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .main-content {
                margin-left: 0;
                width: 100%;
                padding: 15px;
            }

            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
                width: 250px;
            }

            .sidebar.mobile-open {
                transform: translateX(0);
            }
            
            .mobile-menu-toggle {
                display: block;
                position: fixed;
                top: 15px;
                left: 15px;
                z-index: 100;
                background: var(--primary);
                color: white;
                border: none;
                width: 40px;
                height: 40px;
                border-radius: 50%;
                font-size: 1.2rem;
                cursor: pointer;
                box-shadow: var(--shadow-md);
            }

            .chart-card {
                height: 300px;
            }

            .chart-wrapper {
                height: 200px;
            }

            .charts-container {
                grid-template-columns: 1fr;
            }

            .filters-row {
                flex-direction: column;
            }

            .filter-group {
                min-width: 100%;
            }

            .header {
                flex-direction: column;
                gap: 16px;
                align-items: stretch;
                margin-top: 20px;
            }

            .header-actions {
                justify-content: stretch;
            }

            .header-actions .btn {
                flex: 1;
                justify-content: center;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .top-stats {
                grid-template-columns: 1fr;
            }
            
            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .table {
                min-width: 600px;
            }
        }
        
        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .header h2 {
                font-size: 1.5rem;
            }
        }

        /* Reset e Configurações Gerais */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --accent: #8b5cf6;
            --border: #e5e7eb;
            --danger: #ef4444;
            --dark: #1f2937;
            --gray: #9ca3af;
            --gray-dark: #6b7280;
            --gray-light: #f3f4f6;
            --info: #3b82f6;
            --light: #f9fafb;
            --primary: #2563eb;
            --primary-light: #dbeafe;
            --radius: 8px;
            --radius-sm: 4px;
            --secondary: #10b981;
            --shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --transition: all 0.2s ease;
            --warning: #f59e0b;
        }
    </style>
</head>
<body>
    <!-- Botão de menu mobile -->
    <button class="mobile-menu-toggle" style="display: none;">
        <i class="fas fa-bars"></i>
    </button>

    <div class="container">
        <!-- Sidebar -->
        <nav class="sidebar">
            <div class="logo">
                <div class="logo-icon">
                    <i class="fas fa-tshirt"></i>
                </div>
                <div class="logo-text">
                    <h1>Gestão Operacional</h1>
                    <p>Sistema de Solicitações</p>
                </div>
            </div>

            <div class="nav-menu">
                <div class="nav-item">
                    <a href="#dashboard" class="nav-link active" data-section="dashboard">
                        <i class="fas fa-chart-line"></i>
                        <span>Dashboard</span>
                    </a>
                </div>
                
                <div class="nav-item">
                    <a href="#colaboradores" class="nav-link" data-section="colaboradores">
                        <i class="fas fa-users"></i>
                        <span>Colaboradores</span>
                    </a>
                </div>
                
                <div class="nav-item">
                    <a href="#itens" class="nav-link" data-section="itens">
                        <i class="fas fa-tshirt"></i>
                        <span>Itens</span>
                    </a>
                </div>
                
                <div class="nav-item">
                    <a href="#solicitacoes" class="nav-link" data-section="solicitacoes">
                        <i class="fas fa-clipboard-list"></i>
                        <span>Solicitações</span>
                    </a>
                </div>
                
                <div class="nav-item">
                    <a href="#departamentos" class="nav-link" data-section="departamentos">
                        <i class="fas fa-building"></i>
                        <span>Departamentos</span>
                    </a>
                </div>
                
                <div class="nav-item">
                    <a href="#empresas" class="nav-link" data-section="empresas">
                        <i class="fas fa-building"></i>
                        <span>Empresas</span>
                    </a>
                </div>
                
                <div class="nav-item">
                    <a href="#configuracoes" class="nav-link" data-section="configuracoes">
                        <i class="fas fa-cog"></i>
                        <span>Configurações</span>
                    </a>
                </div>
            </div>

            <div class="user-section">
                <div class="user-avatar">AD</div>
                <div class="user-info">
                    <h4>Administrador</h4>
                    <p>admin@empresa.com</p>
                </div>
            </div>
        </nav>

        <!-- Conteúdo Principal -->
        <main class="main-content">
            <!-- Dashboard -->
            <section id="dashboard" class="content-section" style="display: block;">
                <div class="header">
                    <h2>Dashboard</h2>
                    <div class="header-actions">
                        <button class="btn btn-secondary" id="refresh-btn">
                            <i class="fas fa-sync-alt"></i> Atualizar
                        </button>
                        <button class="btn btn-primary" id="export-dashboard-btn">
                            <i class="fas fa-download"></i> Exportar
                        </button>
                        <button class="btn btn-success" id="sync-firebase-btn">
                            <i class="fas fa-cloud-upload-alt"></i> Sincronizar
                        </button>
                    </div>
                </div>

                <!-- Filtros -->
                <div class="dashboard-filters">
                    <div class="filters-row">
                        <div class="filter-group">
                            <label>Período</label>
                            <select id="periodo-select">
                                <option value="todos">Todos</option>
                                <option value="7dias">Últimos 7 dias</option>
                                <option value="30dias">Últimos 30 dias</option>
                                <option value="mes_atual">Mês atual</option>
                                <option value="3meses">Últimos 3 meses</option>
                                <option value="6meses">Últimos 6 meses</option>
                                <option value="1ano">Último ano</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label>Departamento</label>
                            <select id="departamento-select">
                                <option value="todos">Todos os Departamentos</option>
                                <!-- Preenchido por JS -->
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label>Colaborador</label>
                            <select id="colaborador-select">
                                <option value="todos">Todos os Colaboradores</option>
                                <!-- Preenchido por JS -->
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label>Item</label>
                            <select id="item-select">
                                <option value="todos">Todos os Itens</option>
                                <!-- Preenchido por JS -->
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label>Empresa</label>
                            <select id="empresa-select">
                                <option value="todos">Todas as Empresas</option>
                                <!-- Preenchido por JS -->
                            </select>
                        </div>
                    </div>
                    <div id="filtros-ativos" class="mt-2" style="display: none;">
                        <!-- Filtros ativos serão exibidos aqui -->
                    </div>
                </div>

                <!-- Visão Geral -->
                <div class="section-header">
                    <h3 class="section-title">
                        <i class="fas fa-chart-line"></i>
                        Visão Geral
                    </h3>
                </div>

                <!-- Cards de Estatísticas -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-header">
                            <div>
                                <div class="stat-value" id="total-colaboradores">0</div>
                                <div class="stat-label">Colaboradores Ativos</div>
                            </div>
                            <div class="stat-icon blue">
                                <i class="fas fa-users"></i>
                            </div>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <div>
                                <div class="stat-value" id="solicitacoes-pendentes">0</div>
                                <div class="stat-label">Solicitações Pendentes</div>
                            </div>
                            <div class="stat-icon orange">
                                <i class="fas fa-clock"></i>
                            </div>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <div>
                                <div class="stat-value" id="total-solicitacoes">0</div>
                                <div class="stat-label">Total de Solicitações</div>
                            </div>
                            <div class="stat-icon purple">
                                <i class="fas fa-exchange-alt"></i>
                            </div>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <div>
                                <div class="stat-value" id="media-tempo-troca">0 dias</div>
                                <div class="stat-label">Média de Tempo de Troca</div>
                                <small id="media-detalhes" style="font-size: 0.7rem; color: var(--gray);">(todas as solicitações)</small>
                            </div>
                            <div class="stat-icon green">
                                <i class="fas fa-calendar-alt"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Gráficos -->
                <div class="charts-container">
                    <div class="chart-card">
                        <h4><i class="fas fa-chart-bar"></i> Top 5 Colaboradores que Mais Trocam</h4>
                        <div class="chart-wrapper">
                            <canvas id="chart-top-colaboradores"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-card">
                        <h4><i class="fas fa-chart-pie"></i> Solicitações por Departamento</h4>
                        <div class="chart-wrapper">
                            <canvas id="chart-departamentos"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-card">
                        <h4><i class="fas fa-calendar-alt"></i> Solicitações por Mês</h4>
                        <div class="chart-wrapper">
                            <canvas id="chart-mensal"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-card">
                        <h4><i class="fas fa-chart-line"></i> Itens Mais Solicitados</h4>
                        <div class="chart-wrapper">
                            <canvas id="chart-itens"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Top Lists -->
                <div class="top-stats">
                    <div class="top-card">
                        <h4><i class="fas fa-user-crown"></i> Top Colaboradores que Mais Trocam</h4>
                        <ul class="top-list" id="top-colaboradores-list">
                            <!-- Preenchido por JS -->
                        </ul>
                    </div>
                    
                    <div class="top-card">
                        <h4><i class="fas fa-building"></i> Departamentos que Mais Trocam</h4>
                        <ul class="top-list" id="top-departamentos-list">
                            <!-- Preenchido por JS -->
                        </ul>
                    </div>
                    
                    <div class="top-card">
                        <h4><i class="fas fa-tshirt"></i> Itens Mais Trocados</h4>
                        <ul class="top-list" id="top-itens-list">
                            <!-- Preenchido por JS -->
                        </ul>
                    </div>
                </div>

                <!-- Tabela de Últimas Solicitações -->
                <div class="content-section">
                    <div class="section-header">
                        <h4 class="section-title">Últimas Solicitações</h4>
                        <button class="btn btn-primary btn-sm" id="nova-solicitacao-btn">
                            <i class="fas fa-plus"></i> Nova Solicitação
                        </button>
                    </div>
                    
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Colaborador</th>
                                    <th>Departamento</th>
                                    <th>Empresa</th>
                                    <th>Itens</th>
                                    <th>Data</th>
                                    <th>Status</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="ultimas-solicitacoes-tbody">
                                <!-- Preenchido por JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Colaboradores -->
            <section id="colaboradores" class="content-section" style="display: none;">
                <div class="section-header">
                    <h3 class="section-title">
                        <i class="fas fa-users"></i>
                        Colaboradores
                    </h3>
                    <button class="btn btn-primary" id="novo-colaborador-btn">
                        <i class="fas fa-plus"></i> Novo Colaborador
                    </button>
                </div>

                <div class="filters-row mb-4">
                    <div class="filter-group">
                        <label>Buscar</label>
                        <input type="text" id="buscar-colaborador" placeholder="Nome, Departamento ou Status...">
                    </div>
                    <div class="filter-group">
                        <label>Status</label>
                        <select id="filtro-status-colaborador">
                            <option value="todos">Todos</option>
                            <option value="ativo">Ativo</option>
                            <option value="inativo">Inativo</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Departamento</label>
                        <select id="filtro-departamento-colaborador">
                            <option value="todos">Todos os Departamentos</option>
                            <!-- Preenchido por JS -->
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Empresa</label>
                        <select id="filtro-empresa-colaborador">
                            <option value="todos">Todas as Empresas</option>
                            <!-- Preenchido por JS -->
                        </select>
                    </div>
                </div>
                
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Departamento</th>
                                <th>Empresa</th>
                                <th>Admissão</th>
                                <th>Solicitações</th>
                                <th>Última Solicitação</th>
                                <th>Status</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="colaboradores-tbody">
                            <!-- Preenchido por JS -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Itens -->
            <section id="itens" class="content-section" style="display: none;">
                <div class="section-header">
                    <h3 class="section-title">
                        <i class="fas fa-tshirt"></i>
                        Itens
                    </h3>
                    <button class="btn btn-primary" id="novo-item-btn">
                        <i class="fas fa-plus"></i> Novo Item
                    </button>
                </div>

                <div class="filters-row mb-4">
                    <div class="filter-group">
                        <label>Buscar</label>
                        <input type="text" id="buscar-item" placeholder="Nome do item...">
                    </div>
                    <div class="filter-group">
                        <label>Categoria</label>
                        <select id="filtro-categoria-item">
                            <option value="todos">Todas</option>
                            <option value="uniforme">Uniforme</option>
                            <option value="epi">EPI</option>
                            <option value="materiais">Materiais</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Status</label>
                        <select id="filtro-status-item">
                            <option value="todos">Todos</option>
                            <option value="ativo">Ativo</option>
                            <option value="inativo">Inativo</option>
                        </select>
                    </div>
                </div>
                
                <!-- Seção de Tempo Médio de Troca -->
                <div class="content-section media-tempo-section">
                    <div class="section-header">
                        <h4 class="section-title">
                            <i class="fas fa-clock"></i>
                            Tempo Médio de Troca por Item
                        </h4>
                        <small class="text-muted">Baseado em todas as solicitações</small>
                    </div>
                    
                    <div class="media-tempo-grid" id="media-tempo-grid">
                        <!-- Preenchido por JS -->
                    </div>
                </div>
                
                <!-- Tabela de Itens -->
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Categoria</th>
                                <th>Tamanhos</th>
                                <th>Solicitações</th>
                                <th>Tempo Médio</th>
                                <th>Status</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="itens-tbody">
                            <!-- Preenchido por JS -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Solicitações -->
            <section id="solicitacoes" class="content-section" style="display: none;">
                <div class="section-header">
                    <h3 class="section-title">
                        <i class="fas fa-clipboard-list"></i>
                        Solicitações
                    </h3>
                    <button class="btn btn-primary" id="nova-solicitacao-btn2">
                        <i class="fas fa-plus"></i> Nova Solicitação
                    </button>
                </div>

                <div class="filters-row mb-4">
                    <div class="filter-group">
                        <label>Status</label>
                        <select id="filtro-status-solicitacao">
                            <option value="todos">Todos</option>
                            <option value="pendente">Pendente</option>
                            <option value="nao_precisa">Não precisa</option>
                            <option value="realizado">Realizado</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Departamento</label>
                        <select id="filtro-departamento-solicitacao">
                            <option value="todos">Todos</option>
                            <!-- Preenchido por JS -->
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Empresa</label>
                        <select id="filtro-empresa-solicitacao">
                            <option value="todos">Todas</option>
                            <!-- Preenchido por JS -->
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Item</label>
                        <select id="filtro-item-solicitacao">
                            <option value="todos">Todos</option>
                            <!-- Preenchido por JS -->
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Período</label>
                        <select id="filtro-periodo-solicitacao">
                            <option value="todos">Todos</option>
                            <option value="7dias">Últimos 7 dias</option>
                            <option value="30dias">Últimos 30 dias</option>
                            <option value="mes_atual">Mês atual</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Colaborador</label>
                        <select id="filtro-colaborador-solicitacao">
                            <option value="todos">Todos</option>
                            <!-- Preenchido por JS -->
                        </select>
                    </div>
                </div>
                
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Colaborador</th>
                                <th>Departamento</th>
                                <th>Empresa</th>
                                <th>Itens</th>
                                <th>Data</th>
                                <th>Status</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="solicitacoes-tbody">
                            <!-- Preenchido por JS -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Departamentos -->
            <section id="departamentos" class="content-section" style="display: none;">
                <div class="section-header">
                    <h3 class="section-title">
                        <i class="fas fa-building"></i>
                        Departamentos
                    </h3>
                    <button class="btn btn-primary" id="novo-departamento-btn">
                        <i class="fas fa-plus"></i> Novo Departamento
                    </button>
                </div>

                <div class="filters-row mb-4">
                    <div class="filter-group">
                        <label>Buscar</label>
                        <input type="text" id="buscar-departamento" placeholder="Nome do departamento...">
                    </div>
                    <div class="filter-group">
                        <label>Status</label>
                        <select id="filtro-status-departamento">
                            <option value="todos">Todos</option>
                            <option value="ativo">Ativo</option>
                            <option value="inativo">Inativo</option>
                        </select>
                    </div>
                </div>
                
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Colaboradores</th>
                                <th>Solicitações</th>
                                <th>Status</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="departamentos-tbody">
                            <!-- Preenchido por JS -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Empresas -->
            <section id="empresas" class="content-section" style="display: none;">
                <div class="section-header">
                    <h3 class="section-title">
                        <i class="fas fa-building"></i>
                        Empresas
                    </h3>
                    <button class="btn btn-primary" id="nova-empresa-btn">
                        <i class="fas fa-plus"></i> Nova Empresa
                    </button>
                </div>

                <div class="filters-row mb-4">
                    <div class="filter-group">
                        <label>Buscar</label>
                        <input type="text" id="buscar-empresa" placeholder="Nome da empresa...">
                    </div>
                    <div class="filter-group">
                        <label>Status</label>
                        <select id="filtro-status-empresa">
                            <option value="todos">Todos</option>
                            <option value="ativo">Ativo</option>
                            <option value="inativo">Inativo</option>
                        </select>
                    </div>
                </div>
                
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Departamentos</th>
                                <th>Colaboradores</th>
                                <th>Solicitações</th>
                                <th>Status</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="empresas-tbody">
                            <!-- Preenchido por JS -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Configurações -->
            <section id="configuracoes" class="content-section" style="display: none;">
                <div class="section-header">
                    <h3 class="section-title">
                        <i class="fas fa-cog"></i>
                        Configurações
                    </h3>
                </div>

                <div class="content-section">
                    <h4>Limpar Dados do Sistema</h4>
                    <p>Esta ação removerá TODOS os dados do sistema, incluindo:</p>
                    <ul>
                        <li>Todos os colaboradores cadastrados</li>
                        <li>Todos os itens cadastrados</li>
                        <li>Todas as solicitações registradas</li>
                        <li>Todos os departamentos</li>
                        <li>Todas as empresas</li>
                        <li>Dados do localStorage e do Firebase</li>
                    </ul>
                    
                    <div class="danger-zone">
                        <h4><i class="fas fa-exclamation-triangle"></i> Zona de Perigo</h4>
                        <p>Esta ação é <strong>IRREVERSÍVEL</strong>. Todos os dados serão perdidos permanentemente.</p>
                        
                        <div class="form-group">
                            <label class="form-label">Digite "LIMPAR TUDO" para confirmar:</label>
                            <input type="text" class="form-control" id="confirmacao-limpeza" placeholder="LIMPAR TUDO">
                        </div>
                        
                        <div class="form-actions">
                            <button class="btn btn-secondary" onclick="sistema.resetarFormularioLimpeza()">
                                <i class="fas fa-times"></i> Cancelar
                            </button>
                            <button class="btn btn-danger" id="limpar-tudo-btn" disabled>
                                <i class="fas fa-broom"></i> Limpar Todos os Dados
                            </button>
                        </div>
                    </div>
                </div>

                <div class="content-section">
                    <h4>Exportar/Importar Dados</h4>
                    <p>Faça backup ou restaure os dados do sistema.</p>
                    
                    <div class="filters-row">
                        <div class="filter-group">
                            <button class="btn btn-success" id="exportar-backup-btn">
                                <i class="fas fa-file-export"></i> Exportar Backup
                            </button>
                        </div>
                        
                        <div class="filter-group">
                            <label for="importar-backup">Importar Backup</label>
                            <input type="file" id="importar-backup" accept=".json" class="form-control">
                        </div>
                    </div>
                </div>

                <div class="content-section">
                    <h4>Status do Sistema</h4>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-header">
                                <div>
                                    <div class="stat-value" id="status-localstorage">Verificando...</div>
                                    <div class="stat-label">LocalStorage</div>
                                </div>
                                <div class="stat-icon blue">
                                    <i class="fas fa-database"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-header">
                                <div>
                                    <div class="stat-value" id="status-firebase">Verificando...</div>
                                    <div class="stat-label">Firebase</div>
                                </div>
                                <div class="stat-icon green">
                                    <i class="fas fa-cloud"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Modal Colaborador -->
    <div id="modal-colaborador" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-colaborador-title">Novo Colaborador</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="form-colaborador">
                    <input type="hidden" id="colaborador-id">
                    <div class="form-group">
                        <label class="form-label">Nome Completo</label>
                        <input type="text" class="form-control" id="colaborador-nome" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Empresa</label>
                        <select class="form-control" id="colaborador-empresa" required>
                            <option value="">Selecione...</option>
                            <!-- Preenchido por JS -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Departamento</label>
                        <select class="form-control" id="colaborador-departamento" required>
                            <option value="">Selecione...</option>
                            <!-- Preenchido por JS -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Data de Admissão</label>
                        <input type="date" class="form-control" id="colaborador-admissao" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select class="form-control" id="colaborador-status" required>
                            <option value="ativo">Ativo</option>
                            <option value="inativo">Inativo</option>
                        </select>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary modal-close">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Salvar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Item -->
    <div id="modal-item" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-item-title">Novo Item</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="form-item">
                    <input type="hidden" id="item-id">
                    <div class="form-group">
                        <label class="form-label">Nome do Item</label>
                        <input type="text" class="form-control" id="item-nome" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Categoria</label>
                        <select class="form-control" id="item-categoria" required>
                            <option value="">Selecione...</option>
                            <option value="uniforme">Uniforme</option>
                            <option value="epi">EPI</option>
                            <option value="materiais">Materiais</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Tamanhos Disponíveis</label>
                        <input type="text" class="form-control" id="item-tamanhos" placeholder="Ex: P, M, G, GG" required>
                        <small style="color: var(--gray);">Separe os tamanhos com vírgula</small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select class="form-control" id="item-status" required>
                            <option value="ativo">Ativo</option>
                            <option value="inativo">Inativo</option>
                        </select>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary modal-close">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Salvar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Solicitação -->
    <div id="modal-solicitacao" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-solicitacao-title">Nova Solicitação</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="form-solicitacao">
                    <input type="hidden" id="solicitacao-id">
                    <div class="form-group">
                        <label class="form-label">Colaborador</label>
                        <select class="form-control" id="solicitacao-colaborador" required>
                            <option value="">Selecione...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Itens</label>
                        <div id="itens-container">
                            <!-- Itens serão adicionados dinamicamente -->
                        </div>
                        <button type="button" class="btn btn-secondary btn-sm mt-2" id="adicionar-item-btn">
                            <i class="fas fa-plus"></i> Adicionar Item
                        </button>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Data da Solicitação</label>
                        <input type="date" class="form-control" id="solicitacao-data" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select class="form-control" id="solicitacao-status" required>
                            <option value="pendente">Pendente</option>
                            <option value="nao_precisa">Não precisa</option>
                            <option value="realizado">Realizado</option>
                        </select>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary modal-close">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Salvar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Departamento -->
    <div id="modal-departamento" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-departamento-title">Novo Departamento</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="form-departamento">
                    <input type="hidden" id="departamento-id">
                    <div class="form-group">
                        <label class="form-label">Nome do Departamento</label>
                        <input type="text" class="form-control" id="departamento-nome" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select class="form-control" id="departamento-status" required>
                            <option value="ativo">Ativo</option>
                            <option value="inativo">Inativo</option>
                        </select>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary modal-close">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Salvar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Empresa -->
    <div id="modal-empresa" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-empresa-title">Nova Empresa</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="form-empresa">
                    <input type="hidden" id="empresa-id">
                    <div class="form-group">
                        <label class="form-label">Nome da Empresa</label>
                        <input type="text" class="form-control" id="empresa-nome" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select class="form-control" id="empresa-status" required>
                            <option value="ativo">Ativo</option>
                            <option value="inativo">Inativo</option>
                        </select>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary modal-close">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Salvar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="toast">
        <i class="fas fa-check-circle toast-icon"></i>
        <span class="toast-message">Operação realizada com sucesso!</span>
    </div>

    <script>
        class SistemaUniformes {
            constructor() {
                this.useFirebase = true;
                this.firebaseReady = false;
                this.dados = this.getDadosVazios();
                this.charts = {};
                this.filtrosAtivos = {
                    dashboard: { periodo: 'todos', departamento: 'todos', colaborador: 'todos', item: 'todos', empresa: 'todos' },
                    colaboradores: { busca: '', status: 'todos', departamento: 'todos', empresa: 'todos' },
                    itens: { busca: '', categoria: 'todos', status: 'todos' },
                    solicitacoes: { status: 'todos', departamento: 'todos', empresa: 'todos', periodo: 'todos', colaborador: 'todos', item: 'todos' },
                    departamentos: { busca: '', status: 'todos' },
                    empresas: { busca: '', status: 'todos' }
                };
                this.visualizacaoSolicitacoes = {
                    dashboard: { limite: 5, offset: 0 }
                };
                
                this.init();
                this.checkFirebase();
            }

            getDadosVazios() {
                return {
                    colaboradores: [],
                    itens: [],
                    departamentos: [],
                    solicitacoes: [],
                    empresas: []
                };
            }

            async checkFirebase() {
                try {
                    // Aguardar Firebase carregar
                    let attempts = 0;
                    const maxAttempts = 10;
                    
                    const checkInterval = setInterval(() => {
                        attempts++;
                        if (window.firebaseDB && window.firebaseFunctions) {
                            clearInterval(checkInterval);
                            this.firebaseReady = true;
                            this.useFirebase = true;
                            console.log("Firebase conectado com sucesso!");
                            this.mostrarToast("Conectado ao Firebase!", "success");
                            
                            // Carregar dados do Firebase
                            this.carregarDadosFirebase();
                        } else if (attempts >= maxAttempts) {
                            clearInterval(checkInterval);
                            console.log("Firebase não disponível, usando localStorage");
                            this.firebaseReady = false;
                            this.useFirebase = false;
                            this.loadLocalStorageData();
                        }
                    }, 500);
                } catch (error) {
                    console.error("Erro ao verificar Firebase:", error);
                    this.firebaseReady = false;
                    this.useFirebase = false;
                    this.loadLocalStorageData();
                }
            }

            loadLocalStorageData() {
                const dadosCarregados = this.carregarDados();
                
                // Se não houver dados no localStorage, usar dados vazios
                if (dadosCarregados.colaboradores.length === 0 && 
                    dadosCarregados.itens.length === 0 &&
                    dadosCarregados.departamentos.length === 0 &&
                    dadosCarregados.empresas.length === 0) {
                    
                    console.log("Nenhum dado encontrado no localStorage. Inicializando com dados vazios.");
                    this.dados = this.getDadosVazios();
                    
                    // Criar alguns dados de exemplo se estiver em desenvolvimento
                    this.criarDadosExemplo();
                } else {
                    this.dados = dadosCarregados;
                }
                
                this.atualizarSelects();
                this.carregarDashboard();
                this.carregarTabelas();
                this.atualizarDashboardCharts();
                this.carregarTempoMedioItens();
                this.verificarStatusSistema();
            }

            criarDadosExemplo() {
                // Criar uma empresa exemplo
                const empresaExemplo = {
                    id: 1,
                    nome: "Empresa Exemplo",
                    status: "ativo"
                };
                this.dados.empresas.push(empresaExemplo);
                
                // Criar um departamento exemplo
                const departamentoExemplo = {
                    id: 1,
                    nome: "Operações",
                    status: "ativo"
                };
                this.dados.departamentos.push(departamentoExemplo);
                
                // Criar alguns itens exemplo
                const itensExemplo = [
                    {
                        id: 1,
                        nome: "Camiseta",
                        categoria: "uniforme",
                        tamanhos: "P, M, G, GG",
                        status: "ativo",
                        solicitacoes: 0
                    },
                    {
                        id: 2,
                        nome: "Calça",
                        categoria: "uniforme",
                        tamanhos: "38, 40, 42, 44",
                        status: "ativo",
                        solicitacoes: 0
                    },
                    {
                        id: 3,
                        nome: "Luva de Proteção",
                        categoria: "epi",
                        tamanhos: "P, M, G",
                        status: "ativo",
                        solicitacoes: 0
                    }
                ];
                itensExemplo.forEach(item => this.dados.itens.push(item));
                
                console.log("Dados de exemplo criados com sucesso!");
            }

            async carregarDadosFirebase() {
                if (!this.firebaseReady) {
                    this.mostrarToast("Firebase não disponível!", "error");
                    this.loadLocalStorageData();
                    return;
                }
                
                try {
                    this.mostrarToast("Carregando dados do Firebase...", "info");
                    
                    const colecoes = ['colaboradores', 'itens', 'departamentos', 'solicitacoes', 'empresas'];
                    let temDadosFirebase = false;
                    
                    for (const colecao of colecoes) {
                        const querySnapshot = await window.firebaseFunctions.getDocs(
                            window.firebaseFunctions.collection(window.firebaseDB, colecao)
                        );
                        
                        this.dados[colecao] = [];
                        querySnapshot.forEach((doc) => {
                            const data = doc.data();
                            // Manter o ID do documento como string para Firebase
                            this.dados[colecao].push({ id: doc.id, ...data });
                            temDadosFirebase = true;
                        });
                        
                        console.log(`Carregados ${this.dados[colecao].length} registros de ${colecao} do Firebase`);
                    }
                    
                    if (!temDadosFirebase) {
                        this.mostrarToast("Firebase vazio. Usando dados locais.", "info");
                        this.loadLocalStorageData();
                        return;
                    }
                    
                    // Converter IDs numéricos para compatibilidade
                    this.convertFirebaseIds();
                    
                    // Salvar também no localStorage para backup
                    this.salvarDadosLocalStorage();
                    
                    this.mostrarToast("Dados do Firebase carregados com sucesso!", "success");
                    
                    // Atualizar a interface
                    this.atualizarSelects();
                    this.carregarDashboard();
                    this.carregarTabelas();
                    this.atualizarDashboardCharts();
                    this.carregarTempoMedioItens();
                    this.verificarStatusSistema();
                    
                } catch (error) {
                    console.error("Erro ao carregar dados do Firebase:", error);
                    this.mostrarToast("Erro ao carregar dados do Firebase! Usando dados locais.", "error");
                    this.loadLocalStorageData();
                }
            }

            convertFirebaseIds() {
                // Converter IDs de string para número onde possível para manter compatibilidade
                for (const colecao in this.dados) {
                    this.dados[colecao].forEach(item => {
                        // Tentar converter ID para número se possível
                        const idNum = parseInt(item.id);
                        if (!isNaN(idNum)) {
                            item.id = idNum;
                        }
                    });
                }
            }

            carregarDados() {
                // Primeiro tentar carregar do localStorage
                if (typeof(Storage) === "undefined") {
                    console.error("LocalStorage não suportado.");
                    return this.getDadosVazios();
                }

                try {
                    const colaboradores = JSON.parse(localStorage.getItem('uniformes_colaboradores') || "[]");
                    const itens = JSON.parse(localStorage.getItem('uniformes_itens') || "[]");
                    const departamentos = JSON.parse(localStorage.getItem('uniformes_departamentos') || "[]");
                    const solicitacoes = JSON.parse(localStorage.getItem('uniformes_solicitacoes') || "[]");
                    const empresas = JSON.parse(localStorage.getItem('uniformes_empresas') || "[]");

                    return {
                        colaboradores: Array.isArray(colaboradores) ? colaboradores : [],
                        itens: Array.isArray(itens) ? itens : [],
                        departamentos: Array.isArray(departamentos) ? departamentos : [],
                        solicitacoes: Array.isArray(solicitacoes) ? solicitacoes : [],
                        empresas: Array.isArray(empresas) ? empresas : []
                    };
                } catch (error) {
                    console.error("Erro ao carregar dados do localStorage:", error);
                    return this.getDadosVazios();
                }
            }

            async limparTodosDados() {
                const confirmacao = document.getElementById('confirmacao-limpeza').value;
                if (confirmacao !== "LIMPAR TUDO") {
                    this.mostrarToast("Digite 'LIMPAR TUDO' para confirmar!", "error");
                    return;
                }
                
                if (!confirm("⚠️ ATENÇÃO: Esta ação é IRREVERSÍVEL!\n\nTodos os dados serão perdidos permanentemente.\n\nTem certeza que deseja continuar?")) {
                    this.mostrarToast("Operação cancelada.", "info");
                    return;
                }
                
                try {
                    this.mostrarToast("Limpando todos os dados...", "info");
                    
                    // Limpar localStorage
                    this.limparLocalStorage();
                    
                    // Limpar Firebase se estiver conectado
                    if (this.firebaseReady && this.useFirebase) {
                        await this.limparFirebase();
                    }
                    
                    // Reiniciar dados
                    this.dados = this.getDadosVazios();
                    
                    // Atualizar interface
                    this.atualizarSelects();
                    this.carregarDashboard();
                    this.carregarTabelas();
                    this.atualizarDashboardCharts();
                    this.carregarTempoMedioItens();
                    this.verificarStatusSistema();
                    
                    // Resetar formulário de limpeza
                    this.resetarFormularioLimpeza();
                    
                    this.mostrarToast("Todos os dados foram removidos com sucesso!", "success");
                    
                } catch (error) {
                    console.error("Erro ao limpar dados:", error);
                    this.mostrarToast("Erro ao limpar dados!", "error");
                }
            }

            limparLocalStorage() {
                if (typeof(Storage) === "undefined") {
                    console.error("LocalStorage não suportado.");
                    return false;
                }

                try {
                    localStorage.removeItem('uniformes_colaboradores');
                    localStorage.removeItem('uniformes_itens');
                    localStorage.removeItem('uniformes_departamentos');
                    localStorage.removeItem('uniformes_solicitacoes');
                    localStorage.removeItem('uniformes_empresas');
                    console.log("Dados removidos do localStorage com sucesso!");
                    return true;
                } catch (error) {
                    console.error("Erro ao remover dados do localStorage:", error);
                    return false;
                }
            }

            async limparFirebase() {
                if (!this.firebaseReady || !this.useFirebase) {
                    console.log("Firebase não disponível para limpeza.");
                    return false;
                }
                
                try {
                    const colecoes = ['colaboradores', 'itens', 'departamentos', 'solicitacoes', 'empresas'];
                    
                    for (const colecao of colecoes) {
                        // Obter todos os documentos
                        const querySnapshot = await window.firebaseFunctions.getDocs(
                            window.firebaseFunctions.collection(window.firebaseDB, colecao)
                        );
                        
                        // Excluir cada documento
                        const deletePromises = [];
                        querySnapshot.forEach((doc) => {
                            deletePromises.push(
                                window.firebaseFunctions.deleteDoc(
                                    window.firebaseFunctions.doc(window.firebaseDB, colecao, doc.id)
                                )
                            );
                        });
                        
                        // Aguardar todas as exclusões
                        await Promise.all(deletePromises);
                        console.log(`Coleção ${colecao} limpa do Firebase.`);
                    }
                    
                    return true;
                } catch (error) {
                    console.error("Erro ao limpar Firebase:", error);
                    throw error;
                }
            }

            resetarFormularioLimpeza() {
                document.getElementById('confirmacao-limpeza').value = '';
                document.getElementById('limpar-tudo-btn').disabled = true;
            }

            async exportarBackup() {
                try {
                    const dadosCompletos = {
                        colaboradores: this.dados.colaboradores,
                        itens: this.dados.itens,
                        departamentos: this.dados.departamentos,
                        solicitacoes: this.dados.solicitacoes,
                        empresas: this.dados.empresas,
                        dataBackup: new Date().toISOString(),
                        versao: '1.0'
                    };
                    
                    const dadosJSON = JSON.stringify(dadosCompletos, null, 2);
                    const blob = new Blob([dadosJSON], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `backup_uniformes_${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    
                    URL.revokeObjectURL(url);
                    
                    this.mostrarToast("Backup exportado com sucesso!", "success");
                } catch (error) {
                    console.error("Erro ao exportar backup:", error);
                    this.mostrarToast("Erro ao exportar backup!", "error");
                }
            }

            async importarBackup(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                if (!confirm("⚠️ ATENÇÃO: Esta ação substituirá TODOS os dados atuais!\n\nTem certeza que deseja importar o backup?")) {
                    event.target.value = '';
                    return;
                }
                
                try {
                    const reader = new FileReader();
                    
                    reader.onload = async (e) => {
                        try {
                            const dadosImportados = JSON.parse(e.target.result);
                            
                            // Validar estrutura dos dados
                            const colecoesEsperadas = ['colaboradores', 'itens', 'departamentos', 'solicitacoes', 'empresas'];
                            for (const colecao of colecoesEsperadas) {
                                if (!Array.isArray(dadosImportados[colecao])) {
                                    throw new Error(`Estrutura inválida: ${colecao} não é um array`);
                                }
                            }
                            
                            // Atualizar dados
                            this.dados = {
                                colaboradores: dadosImportados.colaboradores,
                                itens: dadosImportados.itens,
                                departamentos: dadosImportados.departamentos,
                                solicitacoes: dadosImportados.solicitacoes,
                                empresas: dadosImportados.empresas
                            };
                            
                            // Salvar no localStorage
                            this.salvarDadosLocalStorage();
                            
                            // Salvar no Firebase se disponível
                            if (this.firebaseReady && this.useFirebase) {
                                await this.sincronizarTodosDadosFirebase();
                            }
                            
                            // Atualizar interface
                            this.atualizarSelects();
                            this.carregarDashboard();
                            this.carregarTabelas();
                            this.atualizarDashboardCharts();
                            this.carregarTempoMedioItens();
                            this.verificarStatusSistema();
                            
                            this.mostrarToast("Backup importado com sucesso!", "success");
                            
                        } catch (error) {
                            console.error("Erro ao processar arquivo de backup:", error);
                            this.mostrarToast("Erro ao importar backup: arquivo inválido!", "error");
                        }
                    };
                    
                    reader.onerror = () => {
                        this.mostrarToast("Erro ao ler arquivo!", "error");
                    };
                    
                    reader.readAsText(file);
                    
                } catch (error) {
                    console.error("Erro ao importar backup:", error);
                    this.mostrarToast("Erro ao importar backup!", "error");
                }
                
                // Limpar input
                event.target.value = '';
            }

            verificarStatusSistema() {
                // Verificar localStorage
                const localStorageEl = document.getElementById('status-localstorage');
                if (localStorageEl) {
                    try {
                        const temDados = localStorage.getItem('uniformes_colaboradores') !== null ||
                                        localStorage.getItem('uniformes_itens') !== null ||
                                        localStorage.getItem('uniformes_departamentos') !== null ||
                                        localStorage.getItem('uniformes_solicitacoes') !== null ||
                                        localStorage.getItem('uniformes_empresas') !== null;
                        
                        if (temDados) {
                            const totalColabs = this.dados.colaboradores.length;
                            const totalItens = this.dados.itens.length;
                            const totalSolic = this.dados.solicitacoes.length;
                            localStorageEl.textContent = `${totalColabs} colabs, ${totalItens} itens, ${totalSolic} solic`;
                            localStorageEl.style.color = 'var(--secondary)';
                        } else {
                            localStorageEl.textContent = 'Vazio';
                            localStorageEl.style.color = 'var(--gray)';
                        }
                    } catch (error) {
                        localStorageEl.textContent = 'Erro';
                        localStorageEl.style.color = 'var(--danger)';
                    }
                }
                
                // Verificar Firebase
                const firebaseEl = document.getElementById('status-firebase');
                if (firebaseEl) {
                    if (this.firebaseReady && this.useFirebase) {
                        firebaseEl.textContent = 'Conectado';
                        firebaseEl.style.color = 'var(--secondary)';
                    } else {
                        firebaseEl.textContent = 'Não conectado';
                        firebaseEl.style.color = 'var(--warning)';
                    }
                }
            }

            salvarDadosLocalStorage() {
                if (typeof(Storage) === "undefined") {
                    console.error("LocalStorage não suportado.");
                    return false;
                }

                try {
                    localStorage.setItem('uniformes_colaboradores', JSON.stringify(this.dados.colaboradores));
                    localStorage.setItem('uniformes_itens', JSON.stringify(this.dados.itens));
                    localStorage.setItem('uniformes_departamentos', JSON.stringify(this.dados.departamentos));
                    localStorage.setItem('uniformes_solicitacoes', JSON.stringify(this.dados.solicitacoes));
                    localStorage.setItem('uniformes_empresas', JSON.stringify(this.dados.empresas));
                    console.log("Dados salvos no localStorage com sucesso!");
                    return true;
                } catch (error) {
                    console.error("Erro ao salvar dados no localStorage:", error);
                    return false;
                }
            }

            async salvarDados() {
                // Salvar sempre no localStorage como backup
                const localStorageSalvo = this.salvarDadosLocalStorage();
                
                // Se Firebase estiver disponível, salvar também lá
                if (this.firebaseReady && this.useFirebase) {
                    try {
                        await this.sincronizarTodosDadosFirebase();
                        return true;
                    } catch (error) {
                        console.error("Erro ao salvar no Firebase:", error);
                        return localStorageSalvo;
                    }
                }
                
                return localStorageSalvo;
            }

            async sincronizarTodosDadosFirebase() {
                if (!this.firebaseReady || !this.useFirebase) return false;
                
                try {
                    const colecoes = ['colaboradores', 'itens', 'departamentos', 'solicitacoes', 'empresas'];
                    
                    for (const colecao of colecoes) {
                        for (const item of this.dados[colecao]) {
                            await this.salvarItemFirebase(colecao, item);
                        }
                    }
                    
                    console.log("Todos os dados sincronizados com Firebase!");
                    return true;
                } catch (error) {
                    console.error("Erro na sincronização completa:", error);
                    throw error;
                }
            }

            async salvarItemFirebase(colecao, item) {
                if (!this.firebaseReady || !this.useFirebase) return null;
                
                try {
                    const itemId = item.id.toString();
                    const itemData = { ...item };
                    delete itemData.id; // Remover id do objeto de dados
                    
                    const docRef = window.firebaseFunctions.doc(window.firebaseDB, colecao, itemId);
                    await window.firebaseFunctions.setDoc(docRef, itemData, { merge: true });
                    
                    console.log(`${colecao} salvo no Firebase com ID: ${itemId}`);
                    return itemId;
                } catch (error) {
                    console.error(`Erro ao salvar ${colecao} no Firebase:`, error);
                    throw error;
                }
            }

            async excluirItemFirebase(colecao, id) {
                if (!this.firebaseReady || !this.useFirebase) return false;
                
                try {
                    const docRef = window.firebaseFunctions.doc(window.firebaseDB, colecao, id.toString());
                    await window.firebaseFunctions.deleteDoc(docRef);
                    console.log(`${colecao} excluído do Firebase: ${id}`);
                    return true;
                } catch (error) {
                    console.error(`Erro ao excluir ${colecao} do Firebase:`, error);
                    return false;
                }
            }

            init() {
                this.setupNavegacao();
                this.setupEventListeners();
                this.setupResponsividade();
                this.setupDate();
                
                // Carregar interface inicialmente com dados locais
                this.loadLocalStorageData();
            }

            setupResponsividade() {
                const menuToggle = document.querySelector('.mobile-menu-toggle');
                const sidebar = document.querySelector('.sidebar');
                
                if (window.innerWidth <= 768) {
                    menuToggle.style.display = 'block';
                    sidebar.classList.remove('mobile-open');
                }
                
                menuToggle.addEventListener('click', () => {
                    sidebar.classList.toggle('mobile-open');
                });
                
                document.querySelectorAll('.nav-link').forEach(link => {
                    link.addEventListener('click', () => {
                        if (window.innerWidth <= 768) {
                            sidebar.classList.remove('mobile-open');
                        }
                    });
                });
                
                window.addEventListener('resize', () => {
                    if (window.innerWidth <= 768) {
                        menuToggle.style.display = 'block';
                    } else {
                        menuToggle.style.display = 'none';
                        sidebar.classList.remove('mobile-open');
                    }
                    
                    this.redesenharGraficos();
                });
            }

            redesenharGraficos() {
                if (this.charts.topColaboradores) {
                    this.charts.topColaboradores.resize();
                }
                if (this.charts.departamentos) {
                    this.charts.departamentos.resize();
                }
                if (this.charts.mensal) {
                    this.charts.mensal.resize();
                }
                if (this.charts.itens) {
                    this.charts.itens.resize();
                }
            }

            setupDate() {
                const hoje = new Date();
                const dataFormatada = hoje.toISOString().split('T')[0];
                const colaboradorAdmissao = document.getElementById('colaborador-admissao');
                const solicitacaoData = document.getElementById('solicitacao-data');
                
                if (colaboradorAdmissao) {
                    colaboradorAdmissao.value = dataFormatada;
                }
                if (solicitacaoData) {
                    solicitacaoData.value = dataFormatada;
                }
            }

            atualizarSelects() {
                this.ordenarDadosAlfabeticamente();
                
                // Atualizar todos os selects
                this.atualizarSelectEmpresas();
                this.atualizarSelectDepartamentos();
                this.atualizarSelectColaboradores();
                this.atualizarSelectItens();
            }

            atualizarSelectEmpresas() {
                const selects = [
                    'empresa-select',
                    'colaborador-empresa',
                    'filtro-empresa-colaborador',
                    'filtro-empresa-solicitacao'
                ];
                
                selects.forEach(selectId => {
                    const select = document.getElementById(selectId);
                    if (select) {
                        select.innerHTML = selectId === 'colaborador-empresa' ? 
                            '<option value="">Selecione...</option>' : 
                            selectId.includes('colaborador') ? '<option value="todos">Todas as Empresas</option>' :
                            '<option value="todos">Todas</option>';
                        
                        this.dados.empresas.forEach(empresa => {
                            if (empresa.status === 'ativo') {
                                const option = document.createElement('option');
                                option.value = empresa.id;
                                option.textContent = empresa.nome;
                                select.appendChild(option);
                            }
                        });
                    }
                });
            }

            atualizarSelectDepartamentos() {
                const selects = [
                    'departamento-select',
                    'colaborador-departamento',
                    'filtro-departamento-colaborador',
                    'filtro-departamento-solicitacao'
                ];
                
                selects.forEach(selectId => {
                    const select = document.getElementById(selectId);
                    if (select) {
                        select.innerHTML = selectId === 'colaborador-departamento' ? 
                            '<option value="">Selecione...</option>' : 
                            selectId.includes('colaborador') ? '<option value="todos">Todos os Departamentos</option>' :
                            '<option value="todos">Todos</option>';
                        
                        this.dados.departamentos.forEach(depto => {
                            if (depto.status === 'ativo') {
                                const option = document.createElement('option');
                                option.value = depto.id;
                                option.textContent = depto.nome;
                                select.appendChild(option);
                            }
                        });
                    }
                });
            }

            atualizarSelectColaboradores() {
                const selects = [
                    'colaborador-select',
                    'solicitacao-colaborador',
                    'filtro-colaborador-solicitacao'
                ];
                
                selects.forEach(selectId => {
                    const select = document.getElementById(selectId);
                    if (select) {
                        select.innerHTML = selectId === 'solicitacao-colaborador' ? 
                            '<option value="">Selecione...</option>' : 
                            '<option value="todos">Todos</option>';
                        
                        this.dados.colaboradores.forEach(colab => {
                            if (colab.status === 'ativo') {
                                const depto = this.dados.departamentos.find(d => d.id === colab.departamentoId);
                                const deptoNome = depto ? depto.nome : 'N/A';
                                const empresa = this.dados.empresas.find(e => e.id === colab.empresaId);
                                const empresaNome = empresa ? empresa.nome : '';
                                const option = document.createElement('option');
                                option.value = colab.id;
                                option.textContent = `${colab.nome} (${deptoNome}${empresaNome ? ` - ${empresaNome}` : ''})`;
                                select.appendChild(option);
                            }
                        });
                    }
                });
            }

            atualizarSelectItens() {
                const selects = [
                    'item-select',
                    'filtro-item-solicitacao'
                ];
                
                selects.forEach(selectId => {
                    const select = document.getElementById(selectId);
                    if (select) {
                        select.innerHTML = '<option value="todos">Todos</option>';
                        
                        this.dados.itens.forEach(item => {
                            if (item.status === 'ativo') {
                                const option = document.createElement('option');
                                option.value = item.id;
                                option.textContent = `${item.nome} (${this.formatarCategoria(item.categoria)})`;
                                select.appendChild(option);
                            }
                        });
                    }
                });
            }

            ordenarDadosAlfabeticamente() {
                this.dados.colaboradores.sort((a, b) => {
                    const nomeA = a.nome.toUpperCase();
                    const nomeB = b.nome.toUpperCase();
                    if (nomeA < nomeB) return -1;
                    if (nomeA > nomeB) return 1;
                    return 0;
                });
                
                this.dados.itens.sort((a, b) => {
                    const nomeA = a.nome.toUpperCase();
                    const nomeB = b.nome.toUpperCase();
                    if (nomeA < nomeB) return -1;
                    if (nomeA > nomeB) return 1;
                    return 0;
                });
                
                this.dados.departamentos.sort((a, b) => {
                    const nomeA = a.nome.toUpperCase();
                    const nomeB = b.nome.toUpperCase();
                    if (nomeA < nomeB) return -1;
                    if (nomeA > nomeB) return 1;
                    return 0;
                });
                
                this.dados.empresas.sort((a, b) => {
                    const nomeA = a.nome.toUpperCase();
                    const nomeB = b.nome.toUpperCase();
                    if (nomeA < nomeB) return -1;
                    if (nomeA > nomeB) return 1;
                    return 0;
                });
            }

            atualizarDashboardCharts() {
                this.criarGraficoTopColaboradores();
                this.criarGraficoDepartamentos();
                this.criarGraficoMensal();
                this.criarGraficoItens();
            }

            criarGraficoTopColaboradores() {
                const ctx = document.getElementById('chart-top-colaboradores');
                if (!ctx) return;
                
                const canvasCtx = ctx.getContext('2d');
                
                const solicitacoesFiltradas = this.getSolicitacoesComFiltrosDashboard();
                
                const colaboradoresComSolicitacoes = this.dados.colaboradores.map(colab => {
                    const solicitacoesTotal = solicitacoesFiltradas.filter(
                        s => s.colaboradorId === colab.id
                    ).length;
                    return {
                        ...colab,
                        solicitacoesTotal: solicitacoesTotal
                    };
                });
                
                const topColaboradores = colaboradoresComSolicitacoes
                    .filter(c => c.status === 'ativo')
                    .sort((a, b) => b.solicitacoesTotal - a.solicitacoesTotal)
                    .slice(0, 5);
                
                const labels = topColaboradores.map(c => c.nome.split(' ')[0]);
                const data = topColaboradores.map(c => c.solicitacoesTotal);
                const cores = this.gerarCores(data.length);
                
                if (this.charts.topColaboradores) {
                    this.charts.topColaboradores.destroy();
                }
                
                this.charts.topColaboradores = new Chart(canvasCtx, {
                    type: 'bar',
                    data: {
                        labels: labels.length > 0 ? labels : ['Nenhum dado'],
                        datasets: [{
                            label: 'Total de Solicitações',
                            data: data.length > 0 ? data : [0],
                            backgroundColor: cores,
                            borderColor: cores.map(c => c.replace('0.8', '1')),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
            }

            criarGraficoDepartamentos() {
                const ctx = document.getElementById('chart-departamentos');
                if (!ctx) return;
                
                const canvasCtx = ctx.getContext('2d');
                
                const solicitacoesFiltradas = this.getSolicitacoesComFiltrosDashboard();
                
                const solicitacoesPorDepartamento = {};
                solicitacoesFiltradas.forEach(solic => {
                    const departamento = this.getDepartamentoNome(solic.departamentoId);
                    solicitacoesPorDepartamento[departamento] = (solicitacoesPorDepartamento[departamento] || 0) + 1;
                });
                
                const labels = Object.keys(solicitacoesPorDepartamento);
                const data = Object.values(solicitacoesPorDepartamento);
                const cores = this.gerarCores(data.length);
                
                if (this.charts.departamentos) {
                    this.charts.departamentos.destroy();
                }
                
                this.charts.departamentos = new Chart(canvasCtx, {
                    type: 'doughnut',
                    data: {
                        labels: labels.length > 0 ? labels : ['Nenhum dado'],
                        datasets: [{
                            data: data.length > 0 ? data : [1],
                            backgroundColor: cores,
                            borderColor: cores.map(c => c.replace('0.8', '1')),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }

            criarGraficoMensal() {
                const ctx = document.getElementById('chart-mensal');
                if (!ctx) return;
                
                const canvasCtx = ctx.getContext('2d');
                
                const solicitacoesFiltradas = this.getSolicitacoesComFiltrosDashboard();
                
                const meses = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
                const solicitacoesPorMes = Array(12).fill(0);
                
                solicitacoesFiltradas.forEach(solic => {
                    const mes = new Date(solic.data).getMonth();
                    solicitacoesPorMes[mes]++;
                });
                
                if (this.charts.mensal) {
                    this.charts.mensal.destroy();
                }
                
                this.charts.mensal = new Chart(canvasCtx, {
                    type: 'line',
                    data: {
                        labels: meses,
                        datasets: [{
                            label: 'Solicitações',
                            data: solicitacoesPorMes,
                            backgroundColor: 'rgba(37, 99, 235, 0.2)',
                            borderColor: 'rgba(37, 99, 235, 1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1
                                }
                            }
                        }
                    }
                });
            }

            criarGraficoItens() {
                const ctx = document.getElementById('chart-itens');
                if (!ctx) return;
                
                const canvasCtx = ctx.getContext('2d');
                
                const solicitacoesFiltradas = this.getSolicitacoesComFiltrosDashboard();
                
                const itensContagem = {};
                solicitacoesFiltradas.forEach(solic => {
                    solic.itens.forEach(item => {
                        const itemNome = item.split(' (')[0];
                        const match = item.match(/- (\d+)$/);
                        const quantidade = match ? parseInt(match[1]) : 1;
                        itensContagem[itemNome] = (itensContagem[itemNome] || 0) + quantidade;
                    });
                });
                
                const topItens = Object.entries(itensContagem)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5);
                
                const labels = topItens.map(item => item[0]);
                const data = topItens.map(item => item[1]);
                const cores = this.gerarCores(data.length);
                
                if (this.charts.itens) {
                    this.charts.itens.destroy();
                }
                
                this.charts.itens = new Chart(canvasCtx, {
                    type: 'bar',
                    data: {
                        labels: labels.length > 0 ? labels : ['Nenhum dado'],
                        datasets: [{
                            label: 'Quantidade Solicitada',
                            data: data.length > 0 ? data : [0],
                            backgroundColor: cores,
                            borderColor: cores.map(c => c.replace('0.8', '1')),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
            }

            getSolicitacoesComFiltrosDashboard() {
                const periodo = this.filtrosAtivos.dashboard.periodo;
                const departamento = this.filtrosAtivos.dashboard.departamento;
                const colaborador = this.filtrosAtivos.dashboard.colaborador;
                const item = this.filtrosAtivos.dashboard.item;
                const empresa = this.filtrosAtivos.dashboard.empresa;
                
                let solicitacoesFiltradas = [...this.dados.solicitacoes];
                
                if (empresa !== 'todos') {
                    const empresaId = parseInt(empresa);
                    solicitacoesFiltradas = solicitacoesFiltradas.filter(s => s.empresaId === empresaId);
                }
                
                if (departamento !== 'todos') {
                    const deptoId = parseInt(departamento);
                    solicitacoesFiltradas = solicitacoesFiltradas.filter(s => s.departamentoId === deptoId);
                }
                
                if (colaborador !== 'todos') {
                    const colaboradorId = parseInt(colaborador);
                    solicitacoesFiltradas = solicitacoesFiltradas.filter(s => s.colaboradorId === colaboradorId);
                }
                
                if (item !== 'todos') {
                    const itemId = parseInt(item);
                    const itemSelecionado = this.dados.itens.find(i => i.id === itemId);
                    if (itemSelecionado) {
                        solicitacoesFiltradas = solicitacoesFiltradas.filter(solic => {
                            return solic.itens.some(itemSolic => {
                                const itemNome = itemSolic.split(' (')[0];
                                return itemNome === itemSelecionado.nome;
                            });
                        });
                    }
                }
                
                if (periodo !== 'todos') {
                    const hoje = new Date();
                    solicitacoesFiltradas = solicitacoesFiltradas.filter(solic => {
                        const dataSolicitacao = new Date(solic.data);
                        const diffDias = Math.floor((hoje - dataSolicitacao) / (1000 * 60 * 60 * 24));
                        
                        if (periodo === '7dias') return diffDias <= 7;
                        if (periodo === '30dias') return diffDias <= 30;
                        if (periodo === 'mes_atual') {
                            return dataSolicitacao.getMonth() === hoje.getMonth() && 
                                   dataSolicitacao.getFullYear() === hoje.getFullYear();
                        }
                        if (periodo === '3meses') return diffDias <= 90;
                        if (periodo === '6meses') return diffDias <= 180;
                        if (periodo === '1ano') return diffDias <= 365;
                        return true;
                    });
                }
                
                return solicitacoesFiltradas;
            }

            calcularMediaTempoTrocaDashboard() {
                const solicitacoesFiltradas = this.getSolicitacoesComFiltrosDashboard();
                
                if (solicitacoesFiltradas.length < 2) {
                    return { mediaDias: 0, texto: "Sem dados suficientes", observacao: "Necessário pelo menos 2 solicitações" };
                }
                
                // Ordena as solicitações por data
                const solicitacoesOrdenadas = [...solicitacoesFiltradas].sort((a, b) => 
                    new Date(a.data) - new Date(b.data)
                );
                
                let totalDias = 0;
                let quantidadeIntervalos = 0;
                
                for (let i = 1; i < solicitacoesOrdenadas.length; i++) {
                    const dataAnterior = new Date(solicitacoesOrdenadas[i-1].data);
                    const dataAtual = new Date(solicitacoesOrdenadas[i].data);
                    const diffDias = Math.floor((dataAtual - dataAnterior) / (1000 * 60 * 60 * 24));
                    
                    if (diffDias > 0) {
                        totalDias += diffDias;
                        quantidadeIntervalos++;
                    }
                }
                
                if (quantidadeIntervalos === 0) {
                    return { mediaDias: 0, texto: "Sem dados suficientes", observacao: "Não foi possível calcular intervalos" };
                }
                
                const mediaDias = Math.round(totalDias / quantidadeIntervalos);
                
                let texto = '';
                if (mediaDias < 30) {
                    texto = `${mediaDias} dias`;
                    if (mediaDias === 1) texto = '1 dia';
                } else if (mediaDias < 365) {
                    const meses = Math.round(mediaDias / 30);
                    texto = `${meses} ${meses === 1 ? 'mês' : 'meses'}`;
                } else {
                    const anos = Math.round(mediaDias / 365);
                    texto = `${anos} ${anos === 1 ? 'ano' : 'anos'}`;
                }
                
                return {
                    mediaDias: mediaDias,
                    texto: texto,
                    observacao: `Baseado em ${solicitacoesFiltradas.length} solicitações (todas)`
                };
            }

            gerarCores(num) {
                const cores = [
                    'rgba(37, 99, 235, 0.8)',
                    'rgba(16, 185, 129, 0.8)',
                    'rgba(139, 92, 246, 0.8)',
                    'rgba(245, 158, 11, 0.8)',
                    'rgba(239, 68, 68, 0.8)',
                    'rgba(59, 130, 246, 0.8)',
                    'rgba(34, 197, 94, 0.8)',
                    'rgba(168, 85, 247, 0.8)'
                ];
                
                return cores.slice(0, num);
            }

            carregarDashboard() {
                this.atualizarEstatisticasDashboard();
                this.carregarTopColaboradores();
                this.carregarTopDepartamentos();
                this.carregarTopItens();
                this.carregarUltimasSolicitacoes();
            }

            atualizarEstatisticasDashboard() {
                const solicitacoesFiltradas = this.getSolicitacoesComFiltrosDashboard();
                
                let colaboradoresFiltrados = this.dados.colaboradores.filter(c => c.status === 'ativo');
                
                if (this.filtrosAtivos.dashboard.empresa !== 'todos') {
                    const empresaId = parseInt(this.filtrosAtivos.dashboard.empresa);
                    colaboradoresFiltrados = colaboradoresFiltrados.filter(c => c.empresaId === empresaId);
                }
                
                if (this.filtrosAtivos.dashboard.departamento !== 'todos') {
                    const deptoId = parseInt(this.filtrosAtivos.dashboard.departamento);
                    colaboradoresFiltrados = colaboradoresFiltrados.filter(c => c.departamentoId === deptoId);
                }
                
                if (this.filtrosAtivos.dashboard.colaborador !== 'todos') {
                    const colaboradorId = parseInt(this.filtrosAtivos.dashboard.colaborador);
                    colaboradoresFiltrados = colaboradoresFiltrados.filter(c => c.id === colaboradorId);
                }
                
                const colaboradoresAtivos = colaboradoresFiltrados.length;
                const solicitacoesPendentes = solicitacoesFiltradas.filter(s => s.status === 'pendente').length;
                const totalSolicitacoes = solicitacoesFiltradas.length;
                
                const mediaTempo = this.calcularMediaTempoTrocaDashboard();
                
                document.getElementById('total-colaboradores').textContent = colaboradoresAtivos;
                document.getElementById('solicitacoes-pendentes').textContent = solicitacoesPendentes;
                document.getElementById('total-solicitacoes').textContent = totalSolicitacoes;
                document.getElementById('media-tempo-troca').textContent = mediaTempo.texto;
                
                const mediaDetalhes = document.getElementById('media-detalhes');
                if (mediaDetalhes) {
                    mediaDetalhes.textContent = `(${mediaTempo.observacao})`;
                }
            }

            carregarTopColaboradores() {
                const container = document.getElementById('top-colaboradores-list');
                if (!container) return;
                
                container.innerHTML = '';
                
                const solicitacoesFiltradas = this.getSolicitacoesComFiltrosDashboard();
                
                const colaboradoresComSolicitacoes = this.dados.colaboradores.map(colab => {
                    const solicitacoesTotal = solicitacoesFiltradas.filter(
                        s => s.colaboradorId === colab.id
                    ).length;
                    return {
                        ...colab,
                        solicitacoesTotal: solicitacoesTotal
                    };
                });
                
                const topColaboradores = colaboradoresComSolicitacoes
                    .filter(c => c.status === 'ativo')
                    .sort((a, b) => b.solicitacoesTotal - a.solicitacoesTotal)
                    .slice(0, 5);
                
                if (topColaboradores.length === 0) {
                    const li = document.createElement('li');
                    li.className = 'top-item';
                    li.innerHTML = `
                        <div class="top-info">
                            <span class="top-name">Nenhum colaborador encontrado</span>
                            <span class="top-details">Cadastre colaboradores para começar</span>
                        </div>
                    `;
                    container.appendChild(li);
                    return;
                }
                
                topColaboradores.forEach((colab, index) => {
                    const li = document.createElement('li');
                    li.className = 'top-item';
                    const departamento = this.getDepartamentoNome(colab.departamentoId);
                    li.innerHTML = `
                        <div class="top-info">
                            <span class="top-name">${index + 1}. ${colab.nome}</span>
                            <span class="top-details">${departamento}</span>
                        </div>
                        <div class="top-count">${colab.solicitacoesTotal}</div>
                    `;
                    container.appendChild(li);
                });
            }

            carregarTopDepartamentos() {
                const container = document.getElementById('top-departamentos-list');
                if (!container) return;
                
                container.innerHTML = '';
                
                const solicitacoesFiltradas = this.getSolicitacoesComFiltrosDashboard();
                
                const solicitacoesPorDepartamento = {};
                const colaboradoresPorDepartamento = {};
                
                solicitacoesFiltradas.forEach(solicitacao => {
                    const departamentoId = solicitacao.departamentoId;
                    if (!solicitacoesPorDepartamento[departamentoId]) {
                        solicitacoesPorDepartamento[departamentoId] = 0;
                    }
                    solicitacoesPorDepartamento[departamentoId]++;
                });
                
                this.dados.colaboradores.forEach(colab => {
                    if (colab.status === 'ativo') {
                        let incluirColaborador = true;
                        
                        if (this.filtrosAtivos.dashboard.empresa !== 'todos') {
                            const empresaId = parseInt(this.filtrosAtivos.dashboard.empresa);
                            if (colab.empresaId !== empresaId) incluirColaborador = false;
                        }
                        
                        if (this.filtrosAtivos.dashboard.departamento !== 'todos') {
                            const deptoId = parseInt(this.filtrosAtivos.dashboard.departamento);
                            if (colab.departamentoId !== deptoId) incluirColaborador = false;
                        }
                        
                        if (incluirColaborador) {
                            if (!colaboradoresPorDepartamento[colab.departamentoId]) {
                                colaboradoresPorDepartamento[colab.departamentoId] = 0;
                            }
                            colaboradoresPorDepartamento[colab.departamentoId]++;
                        }
                    }
                });
                
                const topDepartamentos = Object.entries(solicitacoesPorDepartamento)
                    .map(([departamentoId, quantidade]) => {
                        const departamento = this.dados.departamentos.find(d => d.id === parseInt(departamentoId));
                        return {
                            nome: departamento ? departamento.nome : 'N/A',
                            quantidade: quantidade,
                            colaboradores: colaboradoresPorDepartamento[departamentoId] || 0
                        };
                    })
                    .sort((a, b) => b.quantidade - a.quantidade)
                    .slice(0, 5);
                
                if (topDepartamentos.length === 0) {
                    const li = document.createElement('li');
                    li.className = 'top-item';
                    li.innerHTML = `
                        <div class="top-info">
                            <span class="top-name">Nenhum departamento encontrado</span>
                            <span class="top-details">Cadastre departamentos para começar</span>
                        </div>
                    `;
                    container.appendChild(li);
                    return;
                }
                
                topDepartamentos.forEach((depto, index) => {
                    const li = document.createElement('li');
                    li.className = 'top-item';
                    li.innerHTML = `
                        <div class="top-info">
                            <span class="top-name">${index + 1}. ${depto.nome}</span>
                            <span class="top-details">${depto.colaboradores} colaboradores</span>
                        </div>
                        <div class="top-count">${depto.quantidade}</div>
                    `;
                    container.appendChild(li);
                });
            }

            carregarTopItens() {
                const container = document.getElementById('top-itens-list');
                if (!container) return;
                
                container.innerHTML = '';
                
                const solicitacoesFiltradas = this.getSolicitacoesComFiltrosDashboard();
                
                const itensContagem = {};
                solicitacoesFiltradas.forEach(solic => {
                    solic.itens.forEach(item => {
                        const itemNome = item.split(' (')[0];
                        const match = item.match(/- (\d+)$/);
                        const quantidade = match ? parseInt(match[1]) : 1;
                        itensContagem[itemNome] = (itensContagem[itemNome] || 0) + quantidade;
                    });
                });
                
                const topItens = Object.entries(itensContagem)
                    .map(([nome, quantidade]) => ({ nome, quantidade }))
                    .sort((a, b) => b.quantidade - a.quantidade)
                    .slice(0, 5);
                
                if (topItens.length === 0) {
                    const li = document.createElement('li');
                    li.className = 'top-item';
                    li.innerHTML = `
                        <div class="top-info">
                            <span class="top-name">Nenhum item encontrado</span>
                            <span class="top-details">Cadastre itens para começar</span>
                        </div>
                    `;
                    container.appendChild(li);
                    return;
                }
                
                topItens.forEach((item, index) => {
                    const li = document.createElement('li');
                    li.className = 'top-item';
                    li.innerHTML = `
                        <div class="top-info">
                            <span class="top-name">${index + 1}. ${item.nome}</span>
                        </div>
                        <div class="top-count">${item.quantidade}</div>
                    `;
                    container.appendChild(li);
                });
            }

            carregarUltimasSolicitacoes() {
                const tbody = document.getElementById('ultimas-solicitacoes-tbody');
                if (!tbody) return;
                
                tbody.innerHTML = '';
                
                const solicitacoesFiltradas = this.getSolicitacoesComFiltrosDashboard();
                
                const todasSolicitacoes = [...solicitacoesFiltradas]
                    .sort((a, b) => new Date(b.data) - new Date(a.data));
                
                const limite = this.visualizacaoSolicitacoes.dashboard.limite;
                const solicitacoesParaExibir = todasSolicitacoes.slice(0, limite);
                
                if (solicitacoesParaExibir.length === 0) {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td colspan="7" class="text-center text-muted">
                            Nenhuma solicitação encontrada. <a href="#" onclick="document.getElementById('nova-solicitacao-btn').click(); return false;">Crie a primeira solicitação</a>.
                        </td>
                    `;
                    tbody.appendChild(tr);
                    return;
                }
                
                solicitacoesParaExibir.forEach(solic => {
                    const tr = document.createElement('tr');
                    const departamentoNome = this.getDepartamentoNome(solic.departamentoId);
                    const empresaNome = this.getEmpresaNome(solic.empresaId);
                    
                    const itensHTML = solic.itens.map(item => {
                        const [nomeItem, tamanho] = item.split(' (');
                        const tamanhoFormatado = tamanho ? tamanho.replace(')', '') : '';
                        return `<div class="item-list-row">${nomeItem} ${tamanhoFormatado ? `(${tamanhoFormatado})` : ''}</div>`;
                    }).join('');
                    
                    tr.innerHTML = `
                        <td>${solic.colaboradorNome}</td>
                        <td>${departamentoNome}</td>
                        <td><span class="empresa-badge">${empresaNome}</span></td>
                        <td><div class="item-list">${itensHTML}</div></td>
                        <td>${this.formatarData(solic.data)}</td>
                        <td><span class="badge ${this.getStatusClass(solic.status)}">${this.formatarStatus(solic.status)}</span></td>
                        <td>
                            <button class="btn btn-secondary btn-sm" onclick="sistema.visualizarSolicitacao(${solic.id})">
                                <i class="fas fa-eye"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            }

            visualizarSolicitacao(id) {
                const solicitacao = this.dados.solicitacoes.find(s => s.id === id);
                if (solicitacao) {
                    const departamentoNome = this.getDepartamentoNome(solicitacao.departamentoId);
                    const empresaNome = this.getEmpresaNome(solicitacao.empresaId);
                    const itensStr = solicitacao.itens.join('\n');
                    alert(`Solicitação #${solicitacao.id}\n\nColaborador: ${solicitacao.colaboradorNome}\nDepartamento: ${departamentoNome}\nEmpresa: ${empresaNome}\nData: ${this.formatarData(solicitacao.data)}\nStatus: ${this.formatarStatus(solicitacao.status)}\n\nItens:\n${itensStr}`);
                }
            }

            carregarTabelas() {
                this.carregarTabelaColaboradores();
                this.carregarTabelaItens();
                this.carregarTabelaSolicitacoes();
                this.carregarTabelaDepartamentos();
                this.carregarTabelaEmpresas();
            }

            carregarTabelaEmpresas() {
                const tbody = document.getElementById('empresas-tbody');
                if (!tbody) return;
                
                tbody.innerHTML = '';
                
                if (this.dados.empresas.length === 0) {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td colspan="6" class="text-center text-muted">
                            Nenhuma empresa cadastrada. <a href="#" onclick="document.getElementById('nova-empresa-btn').click(); return false;">Cadastre a primeira empresa</a>.
                        </td>
                    `;
                    tbody.appendChild(tr);
                    return;
                }
                
                this.dados.empresas.forEach(empresa => {
                    const departamentosAtivos = this.dados.departamentos.filter(
                        d => d.status === 'ativo'
                    ).length;
                    
                    const colaboradoresAtivos = this.dados.colaboradores.filter(
                        c => c.empresaId === empresa.id && c.status === 'ativo'
                    ).length;
                    
                    const solicitacoesEmpresa = this.dados.solicitacoes.filter(
                        s => s.empresaId === empresa.id
                    ).length;
                    
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${empresa.nome}</td>
                        <td>${departamentosAtivos}</td>
                        <td>${colaboradoresAtivos}</td>
                        <td>${solicitacoesEmpresa}</td>
                        <td><span class="badge ${empresa.status === 'ativo' ? 'badge-success' : 'badge-danger'}">${empresa.status}</span></td>
                        <td>
                            <button class="btn btn-secondary btn-sm" onclick="sistema.editarEmpresa(${empresa.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="sistema.excluirEmpresa(${empresa.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            }

            carregarTabelaColaboradores() {
                const tbody = document.getElementById('colaboradores-tbody');
                if (!tbody) return;
                
                tbody.innerHTML = '';
                
                if (this.dados.colaboradores.length === 0) {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td colspan="8" class="text-center text-muted">
                            Nenhum colaborador cadastrado. <a href="#" onclick="document.getElementById('novo-colaborador-btn').click(); return false;">Cadastre o primeiro colaborador</a>.
                        </td>
                    `;
                    tbody.appendChild(tr);
                    return;
                }
                
                this.dados.colaboradores.forEach(colab => {
                    const tr = document.createElement('tr');
                    const departamentoNome = this.getDepartamentoNome(colab.departamentoId);
                    const empresaNome = this.getEmpresaNome(colab.empresaId);
                    const solicitacoesColab = this.dados.solicitacoes.filter(s => s.colaboradorId === colab.id).length;
                    const ultimaSolicitacao = this.dados.solicitacoes
                        .filter(s => s.colaboradorId === colab.id)
                        .sort((a, b) => new Date(b.data) - new Date(a.data))[0];
                    
                    tr.innerHTML = `
                        <td>${colab.nome}</td>
                        <td>${departamentoNome}</td>
                        <td><span class="empresa-badge">${empresaNome}</span></td>
                        <td>${this.formatarData(colab.admissao)}</td>
                        <td>${solicitacoesColab}</td>
                        <td>${ultimaSolicitacao ? this.formatarData(ultimaSolicitacao.data) : 'Nenhuma'}</td>
                        <td><span class="badge ${colab.status === 'ativo' ? 'badge-success' : 'badge-danger'}">${colab.status}</span></td>
                        <td>
                            <button class="btn btn-secondary btn-sm" onclick="sistema.editarColaborador(${colab.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="sistema.excluirColaborador(${colab.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            }

            carregarTabelaItens() {
                const tbody = document.getElementById('itens-tbody');
                if (!tbody) return;
                
                tbody.innerHTML = '';
                
                if (this.dados.itens.length === 0) {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td colspan="7" class="text-center text-muted">
                            Nenhum item cadastrado. <a href="#" onclick="document.getElementById('novo-item-btn').click(); return false;">Cadastre o primeiro item</a>.
                        </td>
                    `;
                    tbody.appendChild(tr);
                    return;
                }
                
                this.dados.itens.forEach(item => {
                    const tempoMedio = this.calcularTempoMedioItem(item.id);
                    const solicitacoesItem = this.dados.solicitacoes.filter(solic => {
                        return solic.itens.some(itemSolic => {
                            const itemNome = itemSolic.split(' (')[0];
                            return itemNome === item.nome;
                        });
                    }).length;
                    
                    const tr = document.createElement('tr');
                    
                    tr.innerHTML = `
                        <td>${item.nome}</td>
                        <td>${this.formatarCategoria(item.categoria)}</td>
                        <td>${item.tamanhos}</td>
                        <td>${solicitacoesItem}</td>
                        <td>
                            ${tempoMedio ? `
                                <span class="badge ${this.getClassTempoMedio(tempoMedio.dias)}" title="Baseado em ${tempoMedio.quantidadeSolicitacoes} solicitações (todas)">
                                    ${tempoMedio.texto}
                                </span>
                            ` : '<span class="text-muted">Sem dados</span>'}
                        </td>
                        <td><span class="badge ${item.status === 'ativo' ? 'badge-success' : 'badge-danger'}">${item.status}</span></td>
                        <td>
                            <button class="btn btn-secondary btn-sm" onclick="sistema.editarItem(${item.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="sistema.excluirItem(${item.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            }

            carregarTempoMedioItens() {
                const container = document.getElementById('media-tempo-grid');
                if (!container) return;
                
                container.innerHTML = '';
                
                const itensComTempoMedio = this.dados.itens.map(item => {
                    const tempoMedio = this.calcularTempoMedioItem(item.id);
                    const solicitacoesItem = this.dados.solicitacoes.filter(solic => {
                        return solic.itens.some(itemSolic => {
                            const itemNome = itemSolic.split(' (')[0];
                            return itemNome === item.nome;
                        });
                    }).length;
                    
                    return {
                        ...item,
                        tempoMedio: tempoMedio,
                        solicitacoes: solicitacoesItem
                    };
                });
                
                const itensOrdenados = itensComTempoMedio
                    .filter(item => item.status === 'ativo')
                    .sort((a, b) => b.solicitacoes - a.solicitacoes)
                    .slice(0, 6);
                
                if (itensOrdenados.length === 0) {
                    container.innerHTML = `
                        <div class="text-center text-muted" style="grid-column: 1/-1; padding: 20px;">
                            Nenhum item ativo para exibir tempo médio de troca
                        </div>
                    `;
                    return;
                }
                
                itensOrdenados.forEach(item => {
                    const card = document.createElement('div');
                    card.className = 'media-tempo-card';
                    
                    const categoriaClass = this.getClassCategoria(item.categoria);
                    const tempoMedio = item.tempoMedio;
                    
                    card.innerHTML = `
                        <div class="media-tempo-header">
                            <div>
                                <div class="media-tempo-nome">${item.nome}</div>
                                <div class="media-tempo-categoria ${categoriaClass}">${this.formatarCategoria(item.categoria)}</div>
                            </div>
                            ${tempoMedio ? `
                                <span class="media-tempo-badge ${this.getClassTempoMedio(tempoMedio.dias)}">
                                    ${tempoMedio.texto}
                                </span>
                            ` : '<span class="media-tempo-badge">Sem dados</span>'}
                        </div>
                        
                        <div class="media-tempo-valor">
                            ${item.solicitacoes} solicitações
                        </div>
                        
                        <div class="media-tempo-descricao">
                            ${tempoMedio ? `
                                Baseado em ${tempoMedio.quantidadeSolicitacoes} solicitações (todas)
                                ${tempoMedio.observacao ? `<br><small>${tempoMedio.observacao}</small>` : ''}
                            ` : 'Aguardando solicitações para cálculo'}
                        </div>
                        
                        <div class="media-tempo-footer">
                            <span>Tamanhos: ${item.tamanhos}</span>
                            <span>${tempoMedio ? `Última: ${this.formatarData(tempoMedio.ultimaSolicitacao)}` : ''}</span>
                        </div>
                    `;
                    
                    container.appendChild(card);
                });
            }

            calcularTempoMedioItem(itemId) {
                const item = this.dados.itens.find(i => i.id === itemId);
                if (!item) return null;
                
                // Inclui TODAS as solicitações (pendentes, não precisa, realizadas)
                const solicitacoesDoItem = this.dados.solicitacoes.filter(solic => {
                    return solic.itens.some(itemSolic => {
                        const itemNome = itemSolic.split(' (')[0];
                        return itemNome === item.nome;
                    });
                });
                
                if (solicitacoesDoItem.length < 2) return null;
                
                // Ordena as solicitações por data
                solicitacoesDoItem.sort((a, b) => new Date(a.data) - new Date(b.data));
                
                let totalDias = 0;
                let quantidadeIntervalos = 0;
                
                for (let i = 1; i < solicitacoesDoItem.length; i++) {
                    const dataAnterior = new Date(solicitacoesDoItem[i-1].data);
                    const dataAtual = new Date(solicitacoesDoItem[i].data);
                    const diffDias = Math.floor((dataAtual - dataAnterior) / (1000 * 60 * 60 * 24));
                    
                    if (diffDias > 0) {
                        totalDias += diffDias;
                        quantidadeIntervalos++;
                    }
                }
                
                if (quantidadeIntervalos === 0) return null;
                
                const mediaDias = Math.round(totalDias / quantidadeIntervalos);
                
                let texto = '';
                let observacao = '';
                
                if (mediaDias < 30) {
                    texto = `${mediaDias} dias`;
                    if (mediaDias === 1) texto = '1 dia';
                    observacao = 'Troca frequente';
                } else if (mediaDias < 365) {
                    const meses = Math.round(mediaDias / 30);
                    texto = `${meses} ${meses === 1 ? 'mês' : 'meses'}`;
                    observacao = 'Troca periódica';
                } else {
                    const anos = Math.round(mediaDias / 365);
                    texto = `${anos} ${anos === 1 ? 'ano' : 'anos'}`;
                    observacao = 'Troca de longo prazo';
                }
                
                return {
                    dias: mediaDias,
                    texto: texto,
                    observacao: observacao,
                    quantidadeSolicitacoes: solicitacoesDoItem.length,
                    ultimaSolicitacao: solicitacoesDoItem[solicitacoesDoItem.length - 1].data
                };
            }

            getClassTempoMedio(dias) {
                if (dias < 30) return 'baixa';
                if (dias < 180) return 'media';
                return 'alta';
            }

            getClassCategoria(categoria) {
                const classes = {
                    'uniforme': 'uniforme',
                    'epi': 'epi',
                    'materiais': 'materiais'
                };
                return classes[categoria] || '';
            }

            carregarTabelaSolicitacoes() {
                const tbody = document.getElementById('solicitacoes-tbody');
                if (!tbody) return;
                
                tbody.innerHTML = '';
                
                if (this.dados.solicitacoes.length === 0) {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td colspan="7" class="text-center text-muted">
                            Nenhuma solicitação cadastrada. <a href="#" onclick="document.getElementById('nova-solicitacao-btn2').click(); return false;">Crie a primeira solicitação</a>.
                        </td>
                    `;
                    tbody.appendChild(tr);
                    return;
                }
                
                const todasSolicitacoes = [...this.dados.solicitacoes]
                    .sort((a, b) => new Date(b.data) - new Date(a.data));
                
                todasSolicitacoes.forEach(solic => {
                    const tr = document.createElement('tr');
                    const departamentoNome = this.getDepartamentoNome(solic.departamentoId);
                    const empresaNome = this.getEmpresaNome(solic.empresaId);
                    const statusClass = this.getStatusClass(solic.status);
                    const statusFormatado = this.formatarStatus(solic.status);
                    
                    const itensHTML = solic.itens.map(item => {
                        const [nomeItem, tamanho] = item.split(' (');
                        const tamanhoFormatado = tamanho ? tamanho.replace(')', '') : '';
                        return `<div class="item-list-row">${nomeItem} ${tamanhoFormatado ? `(${tamanhoFormatado})` : ''}</div>`;
                    }).join('');
                    
                    tr.innerHTML = `
                        <td>${solic.colaboradorNome}</td>
                        <td>${departamentoNome}</td>
                        <td><span class="empresa-badge">${empresaNome}</span></td>
                        <td><div class="item-list">${itensHTML}</div></td>
                        <td>${this.formatarData(solic.data)}</td>
                        <td>
                            <span class="badge ${statusClass}">${statusFormatado}</span>
                        </td>
                        <td>
                            <div style="display: flex; gap: 4px; flex-wrap: wrap;">
                                <div class="status-actions">
                                    <button class="status-btn pendente" onclick="sistema.atualizarStatusSolicitacao(${solic.id}, 'pendente')" title="Marcar como Pendente">
                                        P
                                    </button>
                                    <button class="status-btn nao-precisa" onclick="sistema.atualizarStatusSolicitacao(${solic.id}, 'nao_precisa')" title="Marcar como Não Precisa">
                                        NP
                                    </button>
                                    <button class="status-btn realizado" onclick="sistema.atualizarStatusSolicitacao(${solic.id}, 'realizado')" title="Marcar como Realizado">
                                        R
                                    </button>
                                </div>
                                <button class="btn btn-secondary btn-sm" onclick="sistema.editarSolicitacao(${solic.id})" title="Editar">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="sistema.excluirSolicitacao(${solic.id})" title="Excluir">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            }

            carregarTabelaDepartamentos() {
                const tbody = document.getElementById('departamentos-tbody');
                if (!tbody) return;
                
                tbody.innerHTML = '';
                
                if (this.dados.departamentos.length === 0) {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td colspan="5" class="text-center text-muted">
                            Nenhum departamento cadastrado. <a href="#" onclick="document.getElementById('novo-departamento-btn').click(); return false;">Cadastre o primeiro departamento</a>.
                        </td>
                    `;
                    tbody.appendChild(tr);
                    return;
                }
                
                this.dados.departamentos.forEach(depto => {
                    const colaboradoresAtivos = this.dados.colaboradores.filter(
                        c => c.departamentoId === depto.id && c.status === 'ativo'
                    ).length;
                    
                    const solicitacoesDepartamento = this.dados.solicitacoes.filter(
                        s => s.departamentoId === depto.id
                    ).length;
                    
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${depto.nome}</td>
                        <td>${colaboradoresAtivos}</td>
                        <td>${solicitacoesDepartamento}</td>
                        <td><span class="badge ${depto.status === 'ativo' ? 'badge-success' : 'badge-danger'}">${depto.status}</span></td>
                        <td>
                            <button class="btn btn-secondary btn-sm" onclick="sistema.editarDepartamento(${depto.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="sistema.excluirDepartamento(${depto.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            }

            async atualizarStatusSolicitacao(id, novoStatus) {
                const solicitacao = this.dados.solicitacoes.find(s => s.id === id);
                if (solicitacao) {
                    solicitacao.status = novoStatus;
                    
                    // Salvar no Firebase se disponível
                    if (this.useFirebase && this.firebaseReady) {
                        try {
                            await this.salvarItemFirebase('solicitacoes', solicitacao);
                        } catch (error) {
                            console.error("Erro ao salvar no Firebase:", error);
                        }
                    }
                    
                    const salvou = this.salvarDados();
                    if (salvou) {
                        this.filtrarSolicitacoes();
                        this.carregarDashboard();
                        this.atualizarDashboardCharts();
                        this.carregarTempoMedioItens();
                        this.verificarStatusSistema();
                        this.mostrarToast(`Status da solicitação #${solicitacao.id} atualizado para ${this.formatarStatus(novoStatus)}`);
                    }
                }
            }

            // CRUD Colaboradores
            abrirModal(tipo, id = null) {
                this.fecharModais();
                
                const modal = document.getElementById(`modal-${tipo}`);
                const title = modal.querySelector(`#modal-${tipo}-title`);
                
                if (tipo === 'solicitacao') {
                    this.atualizarSelects();
                    this.limparItensSolicitacao();
                    this.adicionarItemSolicitacao();
                } else if (tipo === 'colaborador' || tipo === 'departamento') {
                    this.atualizarSelects();
                }
                
                if (id) {
                    title.textContent = `Editar ${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`;
                    this.carregarDadosEdicao(tipo, id);
                } else {
                    title.textContent = `Novo ${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`;
                    this.limparFormulario(tipo);
                }
                
                modal.classList.add('active');
            }

            limparFormulario(tipo) {
                const form = document.getElementById(`form-${tipo}`);
                if (form) {
                    form.reset();
                    const hiddenId = form.querySelector('input[type="hidden"]');
                    if (hiddenId) {
                        hiddenId.value = '';
                    }
                }
            }

            limparItensSolicitacao() {
                const container = document.getElementById('itens-container');
                if (container) {
                    container.innerHTML = '';
                }
            }

            carregarDadosEdicao(tipo, id) {
                let item;
                switch(tipo) {
                    case 'colaborador':
                        item = this.dados.colaboradores.find(c => c.id === id);
                        if (item) {
                            document.getElementById('colaborador-id').value = item.id;
                            document.getElementById('colaborador-nome').value = item.nome;
                            document.getElementById('colaborador-empresa').value = item.empresaId;
                            document.getElementById('colaborador-departamento').value = item.departamentoId;
                            document.getElementById('colaborador-admissao').value = item.admissao;
                            document.getElementById('colaborador-status').value = item.status;
                        }
                        break;
                    case 'item':
                        item = this.dados.itens.find(i => i.id === id);
                        if (item) {
                            document.getElementById('item-id').value = item.id;
                            document.getElementById('item-nome').value = item.nome;
                            document.getElementById('item-categoria').value = item.categoria;
                            document.getElementById('item-tamanhos').value = item.tamanhos;
                            document.getElementById('item-status').value = item.status;
                        }
                        break;
                    case 'solicitacao':
                        item = this.dados.solicitacoes.find(s => s.id === id);
                        if (item) {
                            document.getElementById('solicitacao-id').value = item.id;
                            document.getElementById('solicitacao-colaborador').value = item.colaboradorId;
                            document.getElementById('solicitacao-data').value = item.data;
                            document.getElementById('solicitacao-status').value = item.status;
                            
                            this.limparItensSolicitacao();
                            
                            item.itens.forEach(itemDesc => {
                                const match = itemDesc.match(/^(.*?) \((.*?)\) - (\d+)/);
                                if (match) {
                                    const [, itemNome, tamanho, quantidade] = match;
                                    const itemObj = this.dados.itens.find(i => i.nome === itemNome);
                                    if (itemObj) {
                                        this.adicionarItemSolicitacao();
                                        
                                        const container = document.getElementById('itens-container');
                                        const lastItem = container.lastElementChild;
                                        const selectItem = lastItem.querySelector('.item-select');
                                        const selectTamanho = lastItem.querySelector('.size-select');
                                        const inputQuantidade = lastItem.querySelector('.quantity-input');
                                        
                                        selectItem.value = itemObj.id;
                                        
                                        selectItem.dispatchEvent(new Event('change'));
                                        
                                        setTimeout(() => {
                                            selectTamanho.value = tamanho;
                                            inputQuantidade.value = quantidade;
                                        }, 100);
                                    }
                                }
                            });
                        }
                        break;
                    case 'departamento':
                        item = this.dados.departamentos.find(d => d.id === id);
                        if (item) {
                            document.getElementById('departamento-id').value = item.id;
                            document.getElementById('departamento-nome').value = item.nome;
                            document.getElementById('departamento-status').value = item.status;
                        }
                        break;
                    case 'empresa':
                        item = this.dados.empresas.find(e => e.id === id);
                        if (item) {
                            document.getElementById('empresa-id').value = item.id;
                            document.getElementById('empresa-nome').value = item.nome;
                            document.getElementById('empresa-status').value = item.status;
                        }
                        break;
                }
            }

            async salvarColaborador() {
                const id = document.getElementById('colaborador-id').value;
                const nome = document.getElementById('colaborador-nome').value;
                const empresaId = parseInt(document.getElementById('colaborador-empresa').value);
                const departamentoId = parseInt(document.getElementById('colaborador-departamento').value);
                const admissao = document.getElementById('colaborador-admissao').value;
                const status = document.getElementById('colaborador-status').value;

                let colaboradorId = id;
                
                if (id) {
                    const index = this.dados.colaboradores.findIndex(c => c.id == id);
                    if (index !== -1) {
                        this.dados.colaboradores[index] = {
                            ...this.dados.colaboradores[index],
                            nome,
                            empresaId,
                            departamentoId,
                            admissao,
                            status
                        };
                    }
                } else {
                    const novoId = this.dados.colaboradores.length > 0 ? 
                        Math.max(...this.dados.colaboradores.map(c => c.id)) + 1 : 1;
                    
                    const novoColaborador = {
                        id: novoId,
                        nome,
                        empresaId,
                        departamentoId,
                        admissao,
                        status
                    };
                    
                    this.dados.colaboradores.push(novoColaborador);
                    colaboradorId = novoId;
                }

                // Salvar no Firebase se disponível
                if (this.useFirebase && this.firebaseReady) {
                    try {
                        const colaborador = this.dados.colaboradores.find(c => c.id == colaboradorId);
                        await this.salvarItemFirebase('colaboradores', colaborador);
                    } catch (error) {
                        console.error("Erro ao salvar no Firebase:", error);
                    }
                }

                const salvou = this.salvarDados();
                if (salvou) {
                    this.fecharModais();
                    this.carregarTabelas();
                    this.carregarDashboard();
                    this.atualizarDashboardCharts();
                    this.atualizarSelects();
                    this.verificarStatusSistema();
                    this.mostrarToast('Colaborador salvo com sucesso!');
                }
            }

            editarColaborador(id) {
                this.abrirModal('colaborador', id);
            }

            async excluirColaborador(id) {
                if (confirm('Tem certeza que deseja excluir este colaborador?')) {
                    // Excluir do Firebase se disponível
                    if (this.useFirebase && this.firebaseReady) {
                        try {
                            await this.excluirItemFirebase('colaboradores', id);
                        } catch (error) {
                            console.error("Erro ao excluir do Firebase:", error);
                        }
                    }
                    
                    this.dados.colaboradores = this.dados.colaboradores.filter(c => c.id !== id);
                    const salvou = this.salvarDados();
                    if (salvou) {
                        this.carregarTabelas();
                        this.carregarDashboard();
                        this.atualizarDashboardCharts();
                        this.atualizarSelects();
                        this.verificarStatusSistema();
                        this.mostrarToast('Colaborador excluído com sucesso!');
                    }
                }
            }

            // CRUD Itens
            async salvarItem() {
                const id = document.getElementById('item-id').value;
                const nome = document.getElementById('item-nome').value;
                const categoria = document.getElementById('item-categoria').value;
                const tamanhos = document.getElementById('item-tamanhos').value;
                const status = document.getElementById('item-status').value;

                let itemId = id;
                
                if (id) {
                    const index = this.dados.itens.findIndex(i => i.id == id);
                    if (index !== -1) {
                        this.dados.itens[index] = {
                            ...this.dados.itens[index],
                            nome,
                            categoria,
                            tamanhos,
                            status
                        };
                    }
                } else {
                    const novoId = this.dados.itens.length > 0 ? 
                        Math.max(...this.dados.itens.map(i => i.id)) + 1 : 1;
                    
                    const novoItem = {
                        id: novoId,
                        nome,
                        categoria,
                        tamanhos,
                        status,
                        solicitacoes: 0
                    };
                    
                    this.dados.itens.push(novoItem);
                    itemId = novoId;
                }

                // Salvar no Firebase se disponível
                if (this.useFirebase && this.firebaseReady) {
                    try {
                        const item = this.dados.itens.find(i => i.id == itemId);
                        await this.salvarItemFirebase('itens', item);
                    } catch (error) {
                        console.error("Erro ao salvar no Firebase:", error);
                    }
                }

                const salvou = this.salvarDados();
                if (salvou) {
                    this.fecharModais();
                    this.carregarTabelas();
                    this.carregarTempoMedioItens();
                    this.atualizarDashboardCharts();
                    this.atualizarSelects();
                    this.verificarStatusSistema();
                    this.mostrarToast('Item salvo com sucesso!');
                }
            }

            editarItem(id) {
                this.abrirModal('item', id);
            }

            async excluirItem(id) {
                if (confirm('Tem certeza que deseja excluir este item?')) {
                    // Excluir do Firebase se disponível
                    if (this.useFirebase && this.firebaseReady) {
                        try {
                            await this.excluirItemFirebase('itens', id);
                        } catch (error) {
                            console.error("Erro ao excluir do Firebase:", error);
                        }
                    }
                    
                    this.dados.itens = this.dados.itens.filter(i => i.id !== id);
                    const salvou = this.salvarDados();
                    if (salvou) {
                        this.carregarTabelas();
                        this.carregarTempoMedioItens();
                        this.atualizarDashboardCharts();
                        this.atualizarSelects();
                        this.verificarStatusSistema();
                        this.mostrarToast('Item excluído com sucesso!');
                    }
                }
            }

            // CRUD Departamentos
            async salvarDepartamento() {
                const id = document.getElementById('departamento-id').value;
                const nome = document.getElementById('departamento-nome').value;
                const status = document.getElementById('departamento-status').value;

                let departamentoId = id;
                
                if (id) {
                    const index = this.dados.departamentos.findIndex(d => d.id == id);
                    if (index !== -1) {
                        this.dados.departamentos[index] = {
                            ...this.dados.departamentos[index],
                            nome,
                            status
                        };
                    }
                } else {
                    const novoId = this.dados.departamentos.length > 0 ? 
                        Math.max(...this.dados.departamentos.map(d => d.id)) + 1 : 1;
                    
                    const novoDepartamento = {
                        id: novoId,
                        nome,
                        status
                    };
                    
                    this.dados.departamentos.push(novoDepartamento);
                    departamentoId = novoId;
                }

                // Salvar no Firebase se disponível
                if (this.useFirebase && this.firebaseReady) {
                    try {
                        const departamento = this.dados.departamentos.find(d => d.id == departamentoId);
                        await this.salvarItemFirebase('departamentos', departamento);
                    } catch (error) {
                        console.error("Erro ao salvar no Firebase:", error);
                    }
                }

                const salvou = this.salvarDados();
                if (salvou) {
                    this.fecharModais();
                    this.carregarTabelas();
                    this.carregarDashboard();
                    this.atualizarDashboardCharts();
                    this.atualizarSelects();
                    this.verificarStatusSistema();
                    this.mostrarToast('Departamento salvo com sucesso!');
                }
            }

            editarDepartamento(id) {
                this.abrirModal('departamento', id);
            }

            async excluirDepartamento(id) {
                if (confirm('Tem certeza que deseja excluir este departamento? Esta ação não poderá ser desfeita.')) {
                    const colaboradoresNoDepartamento = this.dados.colaboradores.filter(c => c.departamentoId === id);
                    if (colaboradoresNoDepartamento.length > 0) {
                        this.mostrarToast('Não é possível excluir o departamento pois há colaboradores vinculados a ele!', 'error');
                        return;
                    }
                    
                    // Excluir do Firebase se disponível
                    if (this.useFirebase && this.firebaseReady) {
                        try {
                            await this.excluirItemFirebase('departamentos', id);
                        } catch (error) {
                            console.error("Erro ao excluir do Firebase:", error);
                        }
                    }
                    
                    this.dados.departamentos = this.dados.departamentos.filter(d => d.id !== id);
                    const salvou = this.salvarDados();
                    if (salvou) {
                        this.carregarTabelas();
                        this.carregarDashboard();
                        this.atualizarDashboardCharts();
                        this.atualizarSelects();
                        this.verificarStatusSistema();
                        this.mostrarToast('Departamento excluído com sucesso!');
                    }
                }
            }

            // CRUD Empresas
            async salvarEmpresa() {
                const id = document.getElementById('empresa-id').value;
                const nome = document.getElementById('empresa-nome').value;
                const status = document.getElementById('empresa-status').value;

                let empresaId = id;
                
                if (id) {
                    const index = this.dados.empresas.findIndex(e => e.id == id);
                    if (index !== -1) {
                        this.dados.empresas[index] = {
                            ...this.dados.empresas[index],
                            nome,
                            status
                        };
                    }
                } else {
                    const nomeExistente = this.dados.empresas.find(e => e.nome.toLowerCase() === nome.toLowerCase());
                    if (nomeExistente) {
                        this.mostrarToast('Já existe uma empresa com este nome!', 'error');
                        return;
                    }
                    
                    const novoId = this.dados.empresas.length > 0 ? 
                        Math.max(...this.dados.empresas.map(e => e.id)) + 1 : 1;
                    
                    const novaEmpresa = {
                        id: novoId,
                        nome,
                        status
                    };
                    
                    this.dados.empresas.push(novaEmpresa);
                    empresaId = novoId;
                }

                // Salvar no Firebase se disponível
                if (this.useFirebase && this.firebaseReady) {
                    try {
                        const empresa = this.dados.empresas.find(e => e.id == empresaId);
                        await this.salvarItemFirebase('empresas', empresa);
                    } catch (error) {
                        console.error("Erro ao salvar no Firebase:", error);
                    }
                }

                const salvou = this.salvarDados();
                if (salvou) {
                    this.fecharModais();
                    this.carregarTabelas();
                    this.carregarDashboard();
                    this.atualizarDashboardCharts();
                    this.atualizarSelects();
                    this.verificarStatusSistema();
                    this.mostrarToast('Empresa salva com sucesso!');
                }
            }

            editarEmpresa(id) {
                this.abrirModal('empresa', id);
            }

            async excluirEmpresa(id) {
                if (confirm('Tem certeza que deseja excluir esta empresa? Esta ação não poderá ser desfeita.')) {
                    const colaboradoresNaEmpresa = this.dados.colaboradores.filter(c => c.empresaId === id);
                    if (colaboradoresNaEmpresa.length > 0) {
                        this.mostrarToast('Não é possível excluir a empresa pois há colaboradores vinculados a ela!', 'error');
                        return;
                    }
                    
                    // Excluir do Firebase se disponível
                    if (this.useFirebase && this.firebaseReady) {
                        try {
                            await this.excluirItemFirebase('empresas', id);
                        } catch (error) {
                            console.error("Erro ao excluir do Firebase:", error);
                        }
                    }
                    
                    this.dados.empresas = this.dados.empresas.filter(e => e.id !== id);
                    const salvou = this.salvarDados();
                    if (salvou) {
                        this.carregarTabelas();
                        this.carregarDashboard();
                        this.atualizarDashboardCharts();
                        this.atualizarSelects();
                        this.verificarStatusSistema();
                        this.mostrarToast('Empresa excluída com sucesso!');
                    }
                }
            }

            // CRUD Solicitações
            adicionarItemSolicitacao() {
                const container = document.getElementById('itens-container');
                if (!container) return;
                
                const div = document.createElement('div');
                div.className = 'item-with-quantity';
                
                const select = document.createElement('select');
                select.className = 'form-control item-select';
                select.required = true;
                select.innerHTML = '<option value="">Selecione um item...</option>';
                
                this.dados.itens.forEach(item => {
                    if (item.status === 'ativo') {
                        const option = document.createElement('option');
                        option.value = item.id;
                        option.textContent = `${item.nome} (${this.formatarCategoria(item.categoria)})`;
                        select.appendChild(option);
                    }
                });
                
                const sizeSelect = document.createElement('select');
                sizeSelect.className = 'form-control size-select';
                sizeSelect.innerHTML = '<option value="">Tamanho...</option>';
                
                const quantityInput = document.createElement('input');
                quantityInput.type = 'number';
                quantityInput.min = '1';
                quantityInput.value = '1';
                quantityInput.className = 'form-control quantity-input';
                quantityInput.placeholder = 'Qtd';
                quantityInput.required = true;
                
                select.addEventListener('change', (e) => {
                    const itemId = parseInt(e.target.value);
                    const item = this.dados.itens.find(i => i.id === itemId);
                    sizeSelect.innerHTML = '<option value="">Tamanho...</option>';
                    
                    if (item && item.tamanhos) {
                        const tamanhos = item.tamanhos.split(',').map(t => t.trim());
                        tamanhos.forEach(tamanho => {
                            const option = document.createElement('option');
                            option.value = tamanho;
                            option.textContent = tamanho;
                            sizeSelect.appendChild(option);
                        });
                    }
                });
                
                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.className = 'btn btn-danger btn-icon remover-item';
                removeBtn.innerHTML = '<i class="fas fa-times"></i>';
                removeBtn.addEventListener('click', function() {
                    div.remove();
                });
                
                div.appendChild(select);
                div.appendChild(sizeSelect);
                div.appendChild(quantityInput);
                div.appendChild(removeBtn);
                container.appendChild(div);
            }

            async salvarSolicitacao() {
                const id = document.getElementById('solicitacao-id').value;
                const colaboradorId = parseInt(document.getElementById('solicitacao-colaborador').value);
                const data = document.getElementById('solicitacao-data').value;
                const status = document.getElementById('solicitacao-status').value;
                
                const itensSelecionados = [];
                const itensParaAtualizar = [];
                
                document.querySelectorAll('#itens-container .item-with-quantity').forEach(container => {
                    const select = container.querySelector('.item-select');
                    const sizeSelect = container.querySelector('.size-select');
                    const quantityInput = container.querySelector('.quantity-input');
                    const itemId = parseInt(select.value);
                    
                    if (itemId && sizeSelect.value && quantityInput.value) {
                        const item = this.dados.itens.find(i => i.id === itemId);
                        if (item) {
                            const quantidade = parseInt(quantityInput.value);
                            const itemDesc = `${item.nome} (${sizeSelect.value}) - ${quantidade}`;
                            itensSelecionados.push(itemDesc);
                            for (let i = 0; i < quantidade; i++) {
                                itensParaAtualizar.push(item);
                            }
                        }
                    }
                });
                
                if (itensSelecionados.length === 0) {
                    this.mostrarToast('Selecione pelo menos um item com tamanho e quantidade!', 'error');
                    return;
                }
                
                const colaborador = this.dados.colaboradores.find(c => c.id === colaboradorId);
                if (!colaborador) {
                    this.mostrarToast('Colaborador não encontrado!', 'error');
                    return;
                }
                
                const departamentoId = colaborador.departamentoId;
                const departamento = this.dados.departamentos.find(d => d.id === departamentoId);
                const empresaId = colaborador.empresaId;
                const empresa = this.dados.empresas.find(e => e.id === empresaId);
                
                let solicitacaoId = id;
                
                if (id) {
                    const index = this.dados.solicitacoes.findIndex(s => s.id == id);
                    if (index !== -1) {
                        const solicitacaoAnterior = this.dados.solicitacoes[index];
                        solicitacaoAnterior.itens.forEach(itemDesc => {
                            const match = itemDesc.match(/^(.*?) \(.*?\) - (\d+)$/);
                            if (match) {
                                const [, itemNome, quantidadeStr] = match;
                                const quantidade = parseInt(quantidadeStr);
                                const item = this.dados.itens.find(i => i.nome === itemNome);
                                if (item) {
                                    item.solicitacoes = Math.max(0, (item.solicitacoes || 0) - quantidade);
                                }
                            }
                        });
                        
                        this.dados.solicitacoes[index] = {
                            ...this.dados.solicitacoes[index],
                            colaboradorId,
                            colaboradorNome: colaborador.nome,
                            departamentoId,
                            empresaId,
                            itens: itensSelecionados,
                            data,
                            status
                        };
                        
                        itensParaAtualizar.forEach(item => {
                            item.solicitacoes = (item.solicitacoes || 0) + 1;
                        });
                    }
                } else {
                    const novoId = this.dados.solicitacoes.length > 0 ? 
                        Math.max(...this.dados.solicitacoes.map(s => s.id)) + 1 : 1;
                    
                    const novaSolicitacao = {
                        id: novoId,
                        colaboradorId,
                        colaboradorNome: colaborador.nome,
                        departamentoId,
                        empresaId,
                        itens: itensSelecionados,
                        data,
                        status
                    };
                    
                    this.dados.solicitacoes.push(novaSolicitacao);
                    solicitacaoId = novoId;
                    
                    itensParaAtualizar.forEach(item => {
                        item.solicitacoes = (item.solicitacoes || 0) + 1;
                    });
                }
                
                // Salvar no Firebase se disponível
                if (this.useFirebase && this.firebaseReady) {
                    try {
                        const solicitacao = this.dados.solicitacoes.find(s => s.id == solicitacaoId);
                        await this.salvarItemFirebase('solicitacoes', solicitacao);
                        
                        // Atualizar itens
                        for (const item of itensParaAtualizar) {
                            await this.salvarItemFirebase('itens', item);
                        }
                    } catch (error) {
                        console.error("Erro ao salvar no Firebase:", error);
                    }
                }

                const salvou = this.salvarDados();
                if (salvou) {
                    this.fecharModais();
                    this.carregarTabelas();
                    this.carregarTempoMedioItens();
                    this.carregarDashboard();
                    this.atualizarDashboardCharts();
                    this.atualizarSelects();
                    this.verificarStatusSistema();
                    this.mostrarToast('Solicitação salva com sucesso!');
                }
            }

            editarSolicitacao(id) {
                this.abrirModal('solicitacao', id);
            }

            async excluirSolicitacao(id) {
                if (confirm('Tem certeza que deseja excluir esta solicitação?')) {
                    const solicitacao = this.dados.solicitacoes.find(s => s.id === id);
                    if (solicitacao) {
                        solicitacao.itens.forEach(itemDesc => {
                            const match = itemDesc.match(/^(.*?) \(.*?\) - (\d+)$/);
                            if (match) {
                                const [, itemNome, quantidadeStr] = match;
                                const quantidade = parseInt(quantidadeStr);
                                const item = this.dados.itens.find(i => i.nome === itemNome);
                                if (item) {
                                    item.solicitacoes = Math.max(0, (item.solicitacoes || 0) - quantidade);
                                }
                            }
                        });
                        
                        // Excluir do Firebase se disponível
                        if (this.useFirebase && this.firebaseReady) {
                            try {
                                await this.excluirItemFirebase('solicitacoes', id);
                            } catch (error) {
                                console.error("Erro ao excluir do Firebase:", error);
                            }
                        }
                    }
                    
                    this.dados.solicitacoes = this.dados.solicitacoes.filter(s => s.id !== id);
                    const salvou = this.salvarDados();
                    if (salvou) {
                        this.carregarTabelas();
                        this.carregarTempoMedioItens();
                        this.carregarDashboard();
                        this.atualizarDashboardCharts();
                        this.verificarStatusSistema();
                        this.mostrarToast('Solicitação excluída com sucesso!');
                    }
                }
            }

            // Filtros
            aplicarFiltrosDashboard() {
                this.atualizarEstatisticasDashboard();
                this.atualizarDashboardCharts();
                this.carregarTopColaboradores();
                this.carregarTopDepartamentos();
                this.carregarTopItens();
                this.carregarUltimasSolicitacoes();
                this.atualizarFiltrosAtivos('dashboard');
            }

            filtrarColaboradores() {
                const busca = this.filtrosAtivos.colaboradores.busca;
                const status = this.filtrosAtivos.colaboradores.status;
                const departamento = this.filtrosAtivos.colaboradores.departamento;
                const empresa = this.filtrosAtivos.colaboradores.empresa;
                
                const linhas = document.querySelectorAll('#colaboradores-tbody tr');
                linhas.forEach(linha => {
                    const nome = linha.cells[0].textContent.toLowerCase();
                    const departamentoLinha = linha.cells[1].textContent.toLowerCase();
                    const empresaLinha = linha.cells[2].textContent.toLowerCase();
                    const statusLinha = linha.cells[6].querySelector('.badge').textContent.toLowerCase();
                    
                    const buscaMatch = busca === '' || 
                                     nome.includes(busca) || 
                                     departamentoLinha.includes(busca) || 
                                     empresaLinha.includes(busca) ||
                                     statusLinha.includes(busca);
                    const statusMatch = status === 'todos' || statusLinha === status;
                    const departamentoMatch = departamento === 'todos' || 
                                     departamentoLinha === this.getDepartamentoNome(parseInt(departamento)).toLowerCase();
                    const empresaMatch = empresa === 'todos' || 
                                     empresaLinha === this.getEmpresaNome(parseInt(empresa)).toLowerCase();
                    
                    linha.style.display = buscaMatch && statusMatch && departamentoMatch && empresaMatch ? '' : 'none';
                });
                this.atualizarFiltrosAtivos('colaboradores');
            }

            filtrarItens() {
                const busca = this.filtrosAtivos.itens.busca;
                const categoria = this.filtrosAtivos.itens.categoria;
                const status = this.filtrosAtivos.itens.status;
                
                const linhas = document.querySelectorAll('#itens-tbody tr');
                linhas.forEach(linha => {
                    const nome = linha.cells[0].textContent.toLowerCase();
                    const categoriaLinha = linha.cells[1].textContent.toLowerCase();
                    const statusLinha = linha.cells[5].querySelector('.badge').textContent.toLowerCase();
                    
                    const buscaMatch = busca === '' || nome.includes(busca);
                    const categoriaMatch = categoria === 'todos' || categoriaLinha === categoria;
                    const statusMatch = status === 'todos' || statusLinha === status;
                    
                    linha.style.display = buscaMatch && categoriaMatch && statusMatch ? '' : 'none';
                });
                this.atualizarFiltrosAtivos('itens');
            }

            filtrarSolicitacoes() {
                const status = this.filtrosAtivos.solicitacoes.status;
                const departamento = this.filtrosAtivos.solicitacoes.departamento;
                const empresa = this.filtrosAtivos.solicitacoes.empresa;
                const item = this.filtrosAtivos.solicitacoes.item;
                const periodo = this.filtrosAtivos.solicitacoes.periodo;
                const colaborador = this.filtrosAtivos.solicitacoes.colaborador;
                
                const tbody = document.getElementById('solicitacoes-tbody');
                if (!tbody) return;
                
                tbody.innerHTML = '';
                
                let solicitacoesFiltradas = [...this.dados.solicitacoes];
                
                if (status !== 'todos') {
                    solicitacoesFiltradas = solicitacoesFiltradas.filter(s => s.status === status);
                }
                
                if (departamento !== 'todos') {
                    const deptoId = parseInt(departamento);
                    solicitacoesFiltradas = solicitacoesFiltradas.filter(s => s.departamentoId === deptoId);
                }
                
                if (empresa !== 'todos') {
                    const empresaId = parseInt(empresa);
                    solicitacoesFiltradas = solicitacoesFiltradas.filter(s => s.empresaId === empresaId);
                }
                
                if (colaborador !== 'todos') {
                    const colaboradorId = parseInt(colaborador);
                    solicitacoesFiltradas = solicitacoesFiltradas.filter(s => s.colaboradorId === colaboradorId);
                }
                
                if (item !== 'todos') {
                    const itemId = parseInt(item);
                    const itemSelecionado = this.dados.itens.find(i => i.id === itemId);
                    if (itemSelecionado) {
                        solicitacoesFiltradas = solicitacoesFiltradas.filter(solic => {
                            return solic.itens.some(itemSolic => {
                                const itemNome = itemSolic.split(' (')[0];
                                return itemNome === itemSelecionado.nome;
                            });
                        });
                    }
                }
                
                if (periodo !== 'todos') {
                    const hoje = new Date();
                    solicitacoesFiltradas = solicitacoesFiltradas.filter(solic => {
                        const dataSolicitacao = new Date(solic.data);
                        const diffDias = Math.floor((hoje - dataSolicitacao) / (1000 * 60 * 60 * 24));
                        
                        if (periodo === '7dias') return diffDias <= 7;
                        if (periodo === '30dias') return diffDias <= 30;
                        if (periodo === 'mes_atual') {
                            return dataSolicitacao.getMonth() === hoje.getMonth() && 
                                   dataSolicitacao.getFullYear() === hoje.getFullYear();
                        }
                        return true;
                    });
                }
                
                solicitacoesFiltradas.sort((a, b) => new Date(b.data) - new Date(a.data));
                
                if (solicitacoesFiltradas.length === 0) {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td colspan="7" class="text-center text-muted">
                            Nenhuma solicitação encontrada com os filtros atuais.
                        </td>
                    `;
                    tbody.appendChild(tr);
                    this.atualizarFiltrosAtivos('solicitacoes');
                    return;
                }
                
                solicitacoesFiltradas.forEach(solic => {
                    const tr = document.createElement('tr');
                    const departamentoNome = this.getDepartamentoNome(solic.departamentoId);
                    const empresaNome = this.getEmpresaNome(solic.empresaId);
                    const statusClass = this.getStatusClass(solic.status);
                    const statusFormatado = this.formatarStatus(solic.status);
                    
                    const itensHTML = solic.itens.map(item => {
                        const [nomeItem, tamanho] = item.split(' (');
                        const tamanhoFormatado = tamanho ? tamanho.replace(')', '') : '';
                        return `<div class="item-list-row">${nomeItem} ${tamanhoFormatado ? `(${tamanhoFormatado})` : ''}</div>`;
                    }).join('');
                    
                    tr.innerHTML = `
                        <td>${solic.colaboradorNome}</td>
                        <td>${departamentoNome}</td>
                        <td><span class="empresa-badge">${empresaNome}</span></td>
                        <td><div class="item-list">${itensHTML}</div></td>
                        <td>${this.formatarData(solic.data)}</td>
                        <td>
                            <span class="badge ${statusClass}">${statusFormatado}</span>
                        </td>
                        <td>
                            <div style="display: flex; gap: 4px; flex-wrap: wrap;">
                                <div class="status-actions">
                                    <button class="status-btn pendente" onclick="sistema.atualizarStatusSolicitacao(${solic.id}, 'pendente')" title="Marcar como Pendente">
                                        P
                                    </button>
                                    <button class="status-btn nao-precisa" onclick="sistema.atualizarStatusSolicitacao(${solic.id}, 'nao_precisa')" title="Marcar como Não Precisa">
                                        NP
                                    </button>
                                    <button class="status-btn realizado" onclick="sistema.atualizarStatusSolicitacao(${solic.id}, 'realizado')" title="Marcar como Realizado">
                                        R
                                    </button>
                                </div>
                                <button class="btn btn-secondary btn-sm" onclick="sistema.editarSolicitacao(${solic.id})" title="Editar">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="sistema.excluirSolicitacao(${solic.id})" title="Excluir">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
                this.atualizarFiltrosAtivos('solicitacoes');
            }

            filtrarDepartamentos() {
                const busca = this.filtrosAtivos.departamentos.busca;
                const status = this.filtrosAtivos.departamentos.status;
                
                const linhas = document.querySelectorAll('#departamentos-tbody tr');
                linhas.forEach(linha => {
                    const nome = linha.cells[0].textContent.toLowerCase();
                    const statusLinha = linha.cells[3].querySelector('.badge').textContent.toLowerCase();
                    
                    const buscaMatch = busca === '' || nome.includes(busca);
                    const statusMatch = status === 'todos' || statusLinha === status;
                    
                    linha.style.display = buscaMatch && statusMatch ? '' : 'none';
                });
                this.atualizarFiltrosAtivos('departamentos');
            }

            filtrarEmpresas() {
                const busca = this.filtrosAtivos.empresas.busca;
                const status = this.filtrosAtivos.empresas.status;
                
                const linhas = document.querySelectorAll('#empresas-tbody tr');
                linhas.forEach(linha => {
                    const nome = linha.cells[0].textContent.toLowerCase();
                    const statusLinha = linha.cells[4].querySelector('.badge').textContent.toLowerCase();
                    
                    const buscaMatch = busca === '' || nome.includes(busca);
                    const statusMatch = status === 'todos' || statusLinha === status;
                    
                    linha.style.display = buscaMatch && statusMatch ? '' : 'none';
                });
                this.atualizarFiltrosAtivos('empresas');
            }

            getDepartamentoNome(id) {
                if (!id) return 'N/A';
                const departamento = this.dados.departamentos.find(d => d.id === id);
                return departamento ? departamento.nome : 'N/A';
            }

            getEmpresaNome(id) {
                if (!id) return 'N/A';
                const empresa = this.dados.empresas.find(e => e.id === id);
                return empresa ? empresa.nome : 'N/A';
            }

            // Métodos de utilidade
            atualizarFiltrosAtivos(secao = 'dashboard') {
                const container = document.getElementById('filtros-ativos');
                if (!container) return;
                
                container.innerHTML = '';
                
                let temFiltros = false;
                const filtros = this.filtrosAtivos[secao];
                
                Object.entries(filtros).forEach(([chave, valor]) => {
                    if (valor !== 'todos' && valor !== '' && valor !== 'solicitacoes') {
                        temFiltros = true;
                        const div = document.createElement('div');
                        div.className = 'filter-indicator';
                        
                        let label = '';
                        let valorExibido = valor;
                        
                        switch(chave) {
                            case 'periodo':
                                label = 'Período: ';
                                switch(valor) {
                                    case '7dias': valorExibido = 'Últimos 7 dias'; break;
                                    case '30dias': valorExibido = 'Últimos 30 dias'; break;
                                    case 'mes_atual': valorExibido = 'Mês atual'; break;
                                    case '3meses': valorExibido = 'Últimos 3 meses'; break;
                                    case '6meses': valorExibido = 'Últimos 6 meses'; break;
                                    case '1ano': valorExibido = 'Último ano'; break;
                                }
                                break;
                            case 'departamento':
                                label = 'Departamento: ';
                                if (valor !== 'todos') {
                                    const depto = this.dados.departamentos.find(d => d.id === parseInt(valor));
                                    valorExibido = depto ? depto.nome : valor;
                                }
                                break;
                            case 'empresa':
                                label = 'Empresa: ';
                                if (valor !== 'todos') {
                                    const empresa = this.dados.empresas.find(e => e.id === parseInt(valor));
                                    valorExibido = empresa ? empresa.nome : valor;
                                }
                                break;
                            case 'status':
                                label = 'Status: ';
                                valorExibido = this.formatarStatus(valor);
                                break;
                            case 'categoria':
                                label = 'Categoria: ';
                                valorExibido = this.formatarCategoria(valor);
                                break;
                            case 'colaborador':
                                if (valor !== 'todos') {
                                    const colab = this.dados.colaboradores.find(c => c.id === parseInt(valor));
                                    label = 'Colaborador: ';
                                    valorExibido = colab ? colab.nome : valor;
                                }
                                break;
                            case 'item':
                                if (valor !== 'todos') {
                                    const item = this.dados.itens.find(i => i.id === parseInt(valor));
                                    label = 'Item: ';
                                    valorExibido = item ? item.nome : valor;
                                }
                                break;
                            case 'busca':
                                label = 'Busca: ';
                                break;
                        }
                        
                        if (valorExibido && valor !== 'todos') {
                            div.innerHTML = `
                                ${label}${valorExibido}
                                <span class="clear-filter" onclick="sistema.limparFiltro('${secao}', '${chave}')">
                                    &times;
                                </span>
                            `;
                            container.appendChild(div);
                        }
                    }
                });
                
                container.style.display = temFiltros ? 'flex' : 'none';
                container.style.flexWrap = 'wrap';
                container.style.gap = '8px';
            }

            limparFiltro(secao, chave) {
                let valorPadrao = '';
                
                switch(chave) {
                    case 'periodo':
                    case 'departamento':
                    case 'status':
                    case 'categoria':
                    case 'colaborador':
                    case 'item':
                    case 'empresa':
                        valorPadrao = 'todos';
                        break;
                    case 'busca':
                        valorPadrao = '';
                        break;
                }
                
                this.filtrosAtivos[secao][chave] = valorPadrao;
                
                // Atualizar o select correspondente
                const selectMap = {
                    'periodo': 'periodo-select',
                    'departamento': 'departamento-select',
                    'colaborador': 'colaborador-select',
                    'item': 'item-select',
                    'empresa': 'empresa-select'
                };
                
                if (selectMap[chave]) {
                    const select = document.getElementById(selectMap[chave]);
                    if (select) select.value = valorPadrao;
                }
                
                // Aplicar filtros novamente
                switch(secao) {
                    case 'dashboard':
                        this.aplicarFiltrosDashboard();
                        break;
                }
                
                this.atualizarFiltrosAtivos(secao);
            }

            setupEventListeners() {
                // Botões principais
                document.getElementById('refresh-btn')?.addEventListener('click', () => this.recarregarDados());
                document.getElementById('sync-firebase-btn')?.addEventListener('click', () => this.sincronizarComFirebase());
                
                // Botões de adição
                document.getElementById('novo-colaborador-btn')?.addEventListener('click', () => this.abrirModal('colaborador'));
                document.getElementById('novo-item-btn')?.addEventListener('click', () => this.abrirModal('item'));
                document.getElementById('nova-solicitacao-btn')?.addEventListener('click', () => this.abrirModal('solicitacao'));
                document.getElementById('nova-solicitacao-btn2')?.addEventListener('click', () => this.abrirModal('solicitacao'));
                document.getElementById('novo-departamento-btn')?.addEventListener('click', () => this.abrirModal('departamento'));
                document.getElementById('nova-empresa-btn')?.addEventListener('click', () => this.abrirModal('empresa'));
                
                // Formulários
                document.getElementById('form-colaborador')?.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await this.salvarColaborador();
                });
                
                document.getElementById('form-item')?.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await this.salvarItem();
                });
                
                document.getElementById('form-solicitacao')?.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await this.salvarSolicitacao();
                });
                
                document.getElementById('form-departamento')?.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await this.salvarDepartamento();
                });
                
                document.getElementById('form-empresa')?.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await this.salvarEmpresa();
                });
                
                // Adicionar item dinâmico
                document.getElementById('adicionar-item-btn')?.addEventListener('click', () => {
                    this.adicionarItemSolicitacao();
                });
                
                // Filtros do Dashboard
                document.getElementById('periodo-select')?.addEventListener('change', (e) => {
                    this.filtrosAtivos.dashboard.periodo = e.target.value;
                    this.aplicarFiltrosDashboard();
                });
                
                document.getElementById('departamento-select')?.addEventListener('change', (e) => {
                    this.filtrosAtivos.dashboard.departamento = e.target.value;
                    this.aplicarFiltrosDashboard();
                });
                
                document.getElementById('colaborador-select')?.addEventListener('change', (e) => {
                    this.filtrosAtivos.dashboard.colaborador = e.target.value;
                    this.aplicarFiltrosDashboard();
                });
                
                document.getElementById('item-select')?.addEventListener('change', (e) => {
                    this.filtrosAtivos.dashboard.item = e.target.value;
                    this.aplicarFiltrosDashboard();
                });
                
                document.getElementById('empresa-select')?.addEventListener('change', (e) => {
                    this.filtrosAtivos.dashboard.empresa = e.target.value;
                    this.aplicarFiltrosDashboard();
                });
                
                // Configurações
                document.getElementById('limpar-tudo-btn')?.addEventListener('click', () => {
                    this.limparTodosDados();
                });
                
                document.getElementById('confirmacao-limpeza')?.addEventListener('input', (e) => {
                    const botao = document.getElementById('limpar-tudo-btn');
                    botao.disabled = e.target.value !== "LIMPAR TUDO";
                });
                
                document.getElementById('exportar-backup-btn')?.addEventListener('click', () => {
                    this.exportarBackup();
                });
                
                document.getElementById('importar-backup')?.addEventListener('change', (e) => {
                    this.importarBackup(e);
                });
                
                // Fechar modais
                document.querySelectorAll('.modal-close').forEach(btn => {
                    btn.addEventListener('click', () => {
                        this.fecharModais();
                    });
                });
                
                // Clicar fora para fechar modal
                document.querySelectorAll('.modal').forEach(modal => {
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) {
                            modal.classList.remove('active');
                        }
                    });
                });
            }

            setupNavegacao() {
                const navLinks = document.querySelectorAll('.nav-link');
                const sections = document.querySelectorAll('.content-section');

                navLinks.forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        
                        navLinks.forEach(l => l.classList.remove('active'));
                        link.classList.add('active');
                        
                        const sectionId = link.getAttribute('data-section');
                        sections.forEach(section => {
                            section.style.display = section.id === sectionId ? 'block' : 'none';
                        });
                        
                        if (sectionId === 'dashboard') {
                            this.atualizarDashboardCharts();
                        } else if (sectionId === 'itens') {
                            this.carregarTempoMedioItens();
                        } else if (sectionId === 'configuracoes') {
                            this.verificarStatusSistema();
                        }
                        
                        setTimeout(() => {
                            this.redesenharGraficos();
                        }, 100);
                    });
                });
            }

            async sincronizarComFirebase() {
                if (!this.firebaseReady) {
                    this.mostrarToast("Firebase não disponível!", "error");
                    return;
                }
                
                try {
                    this.mostrarToast("Sincronizando com Firebase...", "info");
                    await this.sincronizarTodosDadosFirebase();
                    this.mostrarToast("Sincronização completa!", "success");
                    
                } catch (error) {
                    console.error("Erro na sincronização:", error);
                    this.mostrarToast("Erro na sincronização!", "error");
                }
            }

            fecharModais() {
                document.querySelectorAll('.modal').forEach(modal => {
                    modal.classList.remove('active');
                });
            }

            mostrarToast(mensagem, tipo = 'success') {
                const toast = document.getElementById('toast');
                if (!toast) return;
                
                const icon = toast.querySelector('.toast-icon');
                
                toast.className = `toast ${tipo === 'error' ? 'toast-error' : 'toast-success'}`;
                icon.className = `fas ${tipo === 'error' ? 'fa-exclamation-circle' : 'fa-check-circle'} toast-icon`;
                toast.querySelector('.toast-message').textContent = mensagem;
                
                toast.classList.add('show');
                
                setTimeout(() => {
                    toast.classList.remove('show');
                }, 3000);
            }

            async recarregarDados() {
                if (this.useFirebase && this.firebaseReady) {
                    await this.carregarDadosFirebase();
                } else {
                    this.dados = this.carregarDados();
                }
                
                this.carregarDashboard();
                this.carregarTabelas();
                this.carregarTempoMedioItens();
                this.atualizarDashboardCharts();
                this.atualizarSelects();
                this.atualizarFiltrosAtivos();
                this.verificarStatusSistema();
                this.mostrarToast('Dados atualizados!', 'info');
            }

            formatarCategoria(categoria) {
                const categorias = {
                    'uniforme': 'Uniforme',
                    'epi': 'EPI',
                    'materiais': 'Materiais'
                };
                return categorias[categoria] || categoria;
            }

            formatarStatus(status) {
                const statusMap = {
                    'pendente': 'Pendente',
                    'nao_precisa': 'Não precisa',
                    'realizado': 'Realizado'
                };
                return statusMap[status] || status;
            }

            getStatusClass(status) {
                const classes = {
                    'pendente': 'badge-warning',
                    'nao_precisa': 'badge-danger',
                    'realizado': 'badge-success'
                };
                return classes[status] || 'badge-secondary';
            }

            formatarData(dataString) {
                if (!dataString) return 'N/A';
                try {
                    const data = new Date(dataString);
                    const dataCorrigida = new Date(data.getTime() + data.getTimezoneOffset() * 60000);
                    return dataCorrigida.toLocaleDateString('pt-BR');
                } catch {
                    return dataString;
                }
            }
        }

        // Inicializar o sistema
        let sistema;
        document.addEventListener('DOMContentLoaded', () => {
            sistema = new SistemaUniformes();
            window.sistema = sistema;
            
            setTimeout(() => {
                sistema.redesenharGraficos();
            }, 500);
        });
    </script>
</body>
</html>